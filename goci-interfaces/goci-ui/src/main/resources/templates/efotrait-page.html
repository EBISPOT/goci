<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="description"
          content="The NHGRI-EBI GWAS Catalog: a curated collection of all published genome-wide association studies, produced by a collaboration between EMBL-EBI and NHGRI"/>
    <meta name="keywords" content="GWAS Catalog, GWAS, NHGRI, EBI, EMBL-EBI, SPOT"/>
    <meta name="author" content="Tony Burdett, Emma Hastings, Dani Welter, SPOT, EMBL-EBI, NHGRI"/>
    <link rel="icon" href="../static/images/favicon.ico" th:href="@{images/favicon.ico}"/>

    <title>GWAS Catalog</title>
    <!-- Bootstrap core CSS -->
    <link href="../static/css/bootstrap.css" th:href="@{../../css/bootstrap.min.css}" rel="stylesheet"/>
    <!--xintodo disable for offline debug-->
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css"/>
    <!--rel="stylesheet"/>-->
    <link href="../static/css/bootstrap-table.css" th:href="@{../../css/bootstrap-table.css}" rel="stylesheet"/>
    <link href="../static/css/bootstrap-theme.css" th:href="@{../../css/bootstrap-theme.min.css}" rel="stylesheet"/>

    <!-- Custom styles for this template -->
    <link href="../static/css/jumbotron.css" th:href="@{../../css/jumbotron.css}" rel="stylesheet"/>
    <link href="../static/css/sticky-footer-navbar.css"
          th:href="@{../../css/sticky-footer-navbar.css}"
          rel="stylesheet"/>

    <!-- Additional styling on top of bootstrap -->
    <link rel="stylesheet" href="../static/css/goci-ui.css" th:href="@{../../css/goci-ui.css}"/>
    <link rel="stylesheet" href="../static/css/icons/flaticon.css" th:href="@{../../css/icons/flaticon.css}"/>
    <link rel="stylesheet"
          href="../static/css/goci-color-palette-1.css"
          th:href="@{../../css/goci-color-palette-1.css}"/>


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<!--Include header-->
<div th:include="fragments/header :: navbar"></div>

<!-- Main jumbotron for a primary marketing message or call to action -->
<div class="jumbotron background-color-primary-accent" style="margin: 0%; padding-bottom: 30px;">
    <div class="container clearfix">
        <div class="col-lg-7 col-md-7 col-sm-7 col-xs-7">
            <h2 style="margin:0px">
                <img alt="externalLink"
                     style="width: 1em; height: auto;"
                     src="../static/icons/dna13.png"
                     th:src="@{/icons/dna13.png}"/><span style="padding-left:10px">Trait</span><span th:text="${rsId}"
                                                                                                     style="padding-left:15px"></span>
            </h2>
        </div>
        <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 col-lg-offset-1 col-md-offset-1 col-sm-offset-1 col-xs-offset-1">
            <!-- search box goes here -->
            <div class="input-group" style="width: 250px; float: right;">
                <input type="text" class="form-control" placeholder="Search the catalog" id="search-box"/>
                <span class="input-group-btn">
                        <button class="btn btn-default" type="button" id="search-button">
                            <span class="glyphicon glyphicon-search"></span>
                        </button>
                    </span>
            </div>
        </div>
    </div>
</div>

<!--init search parameter-->
<div style="display: none">
    <ul th:object="${result}" id="variables">
        <li id="query" th:text="*{query}">User query</li>
        <li id="facet" th:text="*{facet}">Facet</li>
        <li id="filter" th:text="*{filter}">Disease trait</li>
        <li id="included" th:text="*{included}">Included</li>
    </ul>
</div>
<div style="display:none" id="efo-info"></div>

<!--readme-->
<div class="container-fluid">
    <h4 class="glyphicon glyphicon-question-sign col-md-12" data-toggle="collapse" data-target="#demo">readme</h4>
    <div id="demo" class="collapse">
        <p>This readme button will be removed in production unless required by curator.</p>
        <p>The trait page is designed to integrate/visulize all information about a specific triat(termed <b>mainEFO</b>).
           It
           provedes methods to add/remove other interesting EFOs on top of the mainEFO. It consists of 5 panel boxs:</p>
        <ul>
            <li><b>Trait information:</b>
                This shows a summary of the mainEFO. It also contains a highlighted paper that we selected for this
                triat.
                Currently, the most recent paper is selected as the highlighted paper for the mainEFO.
            </li>
            <li><b>Expand your search:</b> This panel displays the currently selected EFOs and gives user three
                                           approaches to add interesting EFOs to the page.
                <ul>
                    <li>Currently selected EFOs are displayed like this: <button type="button" class="btn  btn-default">EFO_0004467:insulin measurement
                        <span class="badge">  X  </span></button> which can be removed by clicking the 'X'. The mainEFO
                        cannot be removed.
                    </li>
                    <li>A shareable link that can be use to recreate the page with the current selection of EFOs. Copy
                        the link by clicking
                        <button type="button" class="btn btn-default"><span class="glyphicon glyphicon-floppy-disk"
                                                                            aria-hidden="true"
                                                                            title="copy to clipboard"></span></button>.
                    </li>
                    <li>
                        <b>Search for additional terms:</b> User can search addition EFOs of interests by typing EFO_id
                                                            or keywords.
                    </li>
                    <li>
                        <b>Related in EFO hierarchy:</b> User can browse efo terms that are closly located to the
                                                         mainEFO in
                                                         the EFO ontology hierarchy. EFO can be expanded by <b>clicking
                                                                                                               the
                                                                                                               '+'</b>
                                                         and can be selected by
                                                         clicking the EFO name.
                    </li>
                    <li>
                        <b>Additional related terms eg. measurements and biomarkers:</b> This network displays the
                                                                                         related EFOs
                                                                                         of the mainEFO. This comes from
                                                                                         an OLS search with the field
                                                                                         'logical_description'. User can
                        <b>DOUBLE click</b>
                                                                                         a node in the network to add it
                                                                                         to the currently selection of
                                                                                         EFOs.
                    </li>

                </ul>
            </li>
            <li><b>Manhattan plot (plot of catalog associations for selected trait):</b>
                Manhattan plot implemented using Locus Zoom. This plot will be updated as new EFOs are added to the
                page.
                <ul>
                    <li>Legend can be toggle by clicking the 'Show legend' button on the topright of the plot(the button
                        is hidden until mouse over).
                    </li>
                    <li>Associations are coloured base on its highlighted EFO term when multiple EFOs have been
                        annotated to the association using
                        'wwwdev.ebi.ac.uk/gwas/beta/rest/api/parentMapping/EFO_0000400'.
                    </li>
                    <li>Highlighted EFO is currently either the selected-term, or a random EFO from the annotated EFOs
                        when multiple selected EFO are annotated to the association.
                    </li>
                    <li>Click 'download image' to download an svg of the current plot.
                    </li>
                </ul>
            </li>

            <li>
                <b>Association table:</b> All association found in the GWAS catalog for the selected triat(s).
            </li>


            <li>
                <b>studies table:</b> All studies found in the GWAS catalog for the selected triat(s).
            </li>
        </ul>
    </div>
</div>



<!--main container-->
<div class="container-fluid" style="padding-top: 30px">
    <!--search meta data-->
    <ol class="breadcrumb background-color-complementary-accent">
        <li><a href="index.html" th:href="@{/home}">GWAS</a></li>
        <li><a href="#">Traits</a></li>
        <li class="active" th:text="${result.query}"></li>
    </ol>





    <!--disable when search is invalid-->
    <div class="container-fluid" id="lower_container">


        <!--<div class="row" style="margin-top:10px">-->
            <!--<div class="panel panel-default">-->
                <!--<div class="panel-heading background-color-primary-accent">-->
                    <!--<h3 class="panel-title">debug information</h3>-->
                <!--</div>-->

                <!--<button id="btn-toggle-sidebar"-->
                        <!--type="button"-->
                        <!--class="btn btn-default" onclick="$('.sidebar').sidebar('toggle')">sidebar</button>-->

            <!--</div>-->
        <!--</div>-->

        <!-- Summary panel -->
        <div class="row" style="margin-top:10px">
            <div id="summary-info" class="panel panel-default" style="padding-left:0px">



                <!--trait summary-->
                <div class="panel-heading background-color-primary-accent">
                    <h3 class="panel-title">Trait information</h3>
                </div>
                <div class="clearfix" id="summary-panel-loading">
                    <div class="panel-body col-lg-10 col-md-10 col-sm-10 col-xs-10">
                        <!--label-->
                        <div class="clearfix col-lg-4">
                            <dl class="dl-horizontal">
                                <dt style="width: 100px;">Label</dt>
                                <dd id="efotrait-label">-</dd>
                            </dl>
                            <!--<div class="col-lg-4 col-md-5 col-sm-5 col-xs-5"-->
                            <!--style="font-weight: bold; margin-bottom: 1em;padding-left:0px">Label-->
                            <!--</div>-->
                            <!--<div class="col-lg-8 col-md-7 col-sm-7 col-xs-7" id="efotrait-label">-</div>-->
                        </div>
                        <!--id-->
                        <div class="clearfix col-lg-4">
                            <dl class="dl-horizontal">
                                <dt style="width: 100px;">Trait EFO id</dt>
                                <dd id="efotrait-id">-</dd>
                            </dl>
                            <!--<div class="col-lg-4 col-md-5 col-sm-5 col-xs-5"-->
                            <!--style="font-weight: bold; margin-bottom: 1em;padding-left:0px">Trait EFO id-->
                            <!--</div>-->
                            <!--<div class="col-lg-8 col-md-7 col-sm-7 col-xs-7" id="efotrait-id">-</div>-->
                        </div>
                        <!--synonym-->
                        <div class="clearfix col-lg-4">
                            <dl class="dl-horizontal">
                                <dt style="width: 100px;">Synonym(s)</dt>
                                <dd id="efotrait-synonym">-</dd>
                            </dl>
                            <!--<div class="col-lg-4 col-md-5 col-sm-5 col-xs-5"-->
                            <!--style="font-weight: bold; margin-bottom: 1em;padding-left:0px">Synonym(s)-->
                            <!--</div>-->
                            <!--<div class="col-lg-8 col-md-7 col-sm-7 col-xs-7" id="efotrait-synonym">-</div>-->
                        </div>
                        <!--description-->
                        <div class="clearfix col-lg-12">
                            <dl class="dl-horizontal">
                                <dt style="width: 100px;">Description</dt>
                                <dd id="efotrait-description">-</dd>
                            </dl>
                            <!--<div class="col-lg-4 col-md-5 col-sm-5 col-xs-5"-->
                            <!--style="font-weight: bold; margin-bottom: 1em;padding-left:0px">Description-->
                            <!--</div>-->
                            <!--<div class="col-lg-8 col-md-7 col-sm-7 col-xs-7" id="efotrait-description">-</div>-->
                        </div>
                    </div>

                    <div class="panel-body col-lg-2 col-md-2 col-sm-2 col-xs-2">
                        <div>
                            <a class="btn btn-default"
                                    type="button"
                                    data-toggle="collapse"
                                    data-target="#highlight-study-panel-loading"
                                    aria-expanded="false"
                                    aria-controls="collapseExample">
                              Show Highlight Study
                            </a>
                        </div>

                        <div>
                            <a class="btn btn-default" id="btn-toggle-oxo"
                                    type="button"
                                    data-toggle="collapse"
                                    data-target="#oxo-graph"
                                    aria-expanded="false">
                              Show OXO
                            </a>
                        </div>

                        <div>
                            <a type="button" class="btn btn-default" id='ols-link'>ols link
                                <span class="glyphicon glyphicon-new-window external-link"></span>
                            </a>
                        </div>

                        <div>
                            <a type="button" class="btn btn-default" id='oxo-link'>oxo link
                                <span class="glyphicon glyphicon-new-window external-link"></span>
                            </a>
                        </div>


                    </div>

                </div>


                <!--highlighted study-->

                <div class="clearfix collapse" id="highlight-study-panel-loading">
                    <div  class="panel-body col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <!--title-->
                        <div class="clearfix col-lg-4">
                            <dl class="dl-horizontal">
                                <dt style="width: 100px;">Title</dt>
                                <dd id="efotrait-highlighted-study-title">-</dd>
                            </dl>
                            <!--<div class="col-lg-4 col-md-5 col-sm-5 col-xs-5"-->
                            <!--style="font-weight: bold; margin-bottom: 1em;padding-left:0px">Highlighted study-->
                            <!--</div>-->
                            <!--<div class="col-lg-8 col-md-7 col-sm-7 col-xs-7" id="efotrait-highlighted-study-title">-</div>-->
                        </div>
                        <!--author-->
                        <div class="clearfix col-lg-4">
                            <dl class="dl-horizontal">
                                <dt style="width: 100px;">Author</dt>
                                <dd id="efotrait-highlighted-study-author">-</dd>
                            </dl>
                            <!--<div class="col-lg-4 col-md-5 col-sm-5 col-xs-5"-->
                            <!--style="font-weight: bold; margin-bottom: 1em;padding-left:0px">Author-->
                            <!--</div>-->
                            <!--<div class="col-lg-8 col-md-7 col-sm-7 col-xs-7" id="efotrait-highlighted-study-author">-</div>-->
                        </div>
                        <!--Catalog Publish Date-->
                        <div class="clearfix col-lg-4">
                            <dl class="dl-horizontal">
                                <dt style="width: 150px;">Catalog Publish Date</dt>
                                <dd id="efotrait-highlighted-study-catalogPublishDate">-</dd>
                            </dl>
                            <!--<div class="col-lg-4 col-md-5 col-sm-5 col-xs-5"-->
                            <!--style="font-weight: bold; margin-bottom: 1em;padding-left:0px">CatalogPublishDate-->
                            <!--</div>-->
                            <!--<div class="col-lg-8 col-md-7 col-sm-7 col-xs-7" id="efotrait-highlighted-study-catalogPublishDate">-</div>-->
                        </div>
                        <!--Abstract-->
                        <div class="clearfix col-lg-12">
                            <dl class="dl-horizontal">
                                <dt style="width: 100px;">Abstract</dt>
                                <dd id="efotrait-highlighted-study-abstract">-</dd>
                            </dl>
                        </div>
                    </div>

                </div>

                <!--oxo graph-->
                <div class="clearfix collapse" id="oxo-graph">
                    <div  class="panel-body col-lg-5 col-md-5 col-sm-5 col-xs-5">
                        <div id="oxo-div" >
                            <h4>oxo:</h4>
                            <div>
                                <div id="oxo-vis" style="height:500px; width:500px; border:1px solid black;overflow: auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--first reported-->
                <div id="efotrait-summary">
                    <span class="glyphicon glyphicon-info-sign" style="padding-right:2px;margin-left:10px"></span>
                    <span id="efotrait-summary-content"></span>
                </div>


            </div>
        </div>


        <div class="row search-results-container" id="search-results-container" style="display: block">
            <!--filter side box-->
            <div class="col-md-5 tight-to-side" id="filter-bar">
                <div class="panel panel-default">
                    <div id="expand_float_panel" class="panel-heading background-color-primary-accent">
                        <h3 class="panel-title">Expand search</h3>
                        <span class="pull-right clickable"
                              onclick="toggleSidebarFlex('#expand_float_panel span.clickable',5,1)">
                                    <i class="glyphicon glyphicon-chevron-up"></i>
                                </span>
                    </div>


                    <div class="panel-body">
                        <div class="row">

                            <div class="col-lg-2">
                                <input id="cb-query-include-descendants" type="checkbox"/>Descendants
                                <!--<input id="cb-query-include-descendants" type="checkbox" checked=""/>Descendants-->
                            </div>
                            <div class="col-lg-9">
                                <button id="btn-cart-check-item-cbs"
                                        type="button"
                                        class="btn btn-default">CheckAll
                                        </button>
                                <button id="btn-cart-uncheck-item-cbs"
                                        type="button"
                                        class="btn btn-default">UnCheckAll
                                        </button>
                                <button id="btn-query-include-related-terms"
                                        type="button"
                                        class="btn btn-default">+related terms
                                        </button>
                                <button id="btn-clear-highlight"
                                        type="button"
                                        class="btn btn-default">clear highlight
                                        </button>
                                <button id="btn-clear-cart"
                                        type="button"
                                        class="btn btn-default">clear cart
                                        </button>
                            </div>

                            <div class="col-lg-1">
                                <input type="text" id="sharable_link" class="col-xs-6" style="display:none" th:readonly="readonly"></input>
                                <div>
                                        <button id="sharable_link_btn"
                                                type="button"
                                                class="btn btn-default"
                                                data-clipboard-target="#sharable_link">
                                          <span class="glyphicon glyphicon-floppy-disk"
                                                aria-hidden="true"
                                                title="copy sharable link to clipboard"></span>
                                         </button>
                                </div>
                            </div>
                        </div>
                        <!--current select-->
                        <div class="row">
                                <b>Current selected:</b>
                            <div class="list-group" id="cart-loading">
                                <div id="cart"></div>
                            </div>
                            <!--<div class="col-lg-12   ">-->
                                <!--&lt;!&ndash;<input id="cb-query-include-descendants" type="checkbox"/> Descendants&ndash;&gt;-->
                                <!--<input id="" type="checkbox" checked=""/>Check/Uncheck all-->
                            <!--</div>-->
                        </div>

                        <!--replot button-->
                        <!--<div class="row">-->
                            <!--&lt;!&ndash;<b>Actions:</b>&ndash;&gt;-->
                            <!--<div>-->
                                <!--&lt;!&ndash;<div class="col-lg-3">&ndash;&gt;-->
                                    <!--&lt;!&ndash;&lt;!&ndash;<input id="cb-query-include-descendants" type="checkbox"/> Descendants&ndash;&gt;&ndash;&gt;-->
                                    <!--&lt;!&ndash;<input id="cb-query-include-descendants" type="checkbox" checked=""/> always include descendants&ndash;&gt;-->
                                <!--&lt;!&ndash;</div>&ndash;&gt;-->
                                <!--&lt;!&ndash;<div class="col-lg-6">&ndash;&gt;-->
                                    <!--&lt;!&ndash;<button id="btn-query-include-descendants"&ndash;&gt;-->
                                            <!--&lt;!&ndash;type="button"&ndash;&gt;-->
                                            <!--&lt;!&ndash;class="btn btn-default">+descendants&ndash;&gt;-->
                                    <!--&lt;!&ndash;</button>&ndash;&gt;-->
                                    <!--&lt;!&ndash;<button id="btn-query-include-related-terms"&ndash;&gt;-->
                                            <!--&lt;!&ndash;type="button"&ndash;&gt;-->
                                            <!--&lt;!&ndash;class="btn btn-default">+related terms&ndash;&gt;-->
                                    <!--&lt;!&ndash;</button>&ndash;&gt;-->
                                    <!--&lt;!&ndash;<button id="btn-clear-highlight"&ndash;&gt;-->
                                            <!--&lt;!&ndash;type="button"&ndash;&gt;-->
                                            <!--&lt;!&ndash;class="btn btn-default">clear highlight&ndash;&gt;-->
                                    <!--&lt;!&ndash;</button>&ndash;&gt;-->

                                    <!--&lt;!&ndash;<button id="btn-clear-cart"&ndash;&gt;-->
                                            <!--&lt;!&ndash;type="button"&ndash;&gt;-->
                                            <!--&lt;!&ndash;class="btn btn-default">clear cart&ndash;&gt;-->
                                    <!--&lt;!&ndash;</button>&ndash;&gt;-->
                                <!--&lt;!&ndash;</div>&ndash;&gt;-->
                                <!--&lt;!&ndash;<div class="col-lg-2">&ndash;&gt;-->
                                    <!--&lt;!&ndash;<input type="text" id="sharable_link" class="col-xs-6" style="display:none" th:readonly="readonly"></input>&ndash;&gt;-->
                                    <!--&lt;!&ndash;<div>&ndash;&gt;-->
                                        <!--&lt;!&ndash;<button id="sharable_link_btn"&ndash;&gt;-->
                                                <!--&lt;!&ndash;type="button"&ndash;&gt;-->
                                                <!--&lt;!&ndash;class="btn btn-default"&ndash;&gt;-->
                                                <!--&lt;!&ndash;data-clipboard-target="#sharable_link">&ndash;&gt;-->
                                          <!--&lt;!&ndash;<span class="glyphicon glyphicon-floppy-disk"&ndash;&gt;-->
                                                <!--&lt;!&ndash;aria-hidden="true"&ndash;&gt;-->
                                                <!--&lt;!&ndash;title="copy sharable link to clipboard"></span>&ndash;&gt;-->
                                         <!--&lt;!&ndash;</button>&ndash;&gt;-->
                                    <!--&lt;!&ndash;</div>&ndash;&gt;-->
                                <!--&lt;!&ndash;</div>&ndash;&gt;-->
                            <!--</div>-->
                        <!--</div>-->

                        <div class="row">
                            <div id="ols-search-div" class="tab-pane fade in active">
                                <h4>Search for additional terms:</h4>
                                <div class="left">
                                    <label>
                                        <input style="font-weight: normal"
                                               size="35"
                                               type="text"
                                               name="q"
                                               data-olswidget="select"
                                               data-olsontology="efo"
                                               data-selectpath="http://www.ebi.ac.uk/ols/"
                                               olstype=""
                                               id="local-searchbox"
                                               placeholder="Enter the term you are looking for"
                                               class="ac_input">
                                        </input>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <!--trying bootstrap nav tab-->
                        <div class="container row col-xs-12">
                            <!--<ul class="nav nav-tabs">-->
                            <!--<li class="active"><a data-toggle="tab" href="#ols-search-div">Search for additional terms</a></li>-->
                            <!--<li><a data-toggle="tab" href="#ols-tree-div">Related in EFO hierarchy</a></li>-->
                            <!--<li><a data-toggle="tab" href="#ols-graph-div">Additional related terms eg. measurements and biomarkers</a></li>-->
                            <!--</ul>-->
                            <ul class="nav nav-tabs">
                                <li><a data-toggle="pill" href="#ols-tree-div">EFO hierarchy</a></li>
                                <li><a data-toggle="pill" href="#ols-graph-div">Additional terms</a></li>
                                <!--<li><a data-toggle="pill" href="#oxo-div">OXO</a></li>-->

                            </ul>


                            <div class="tab-content">
                                <!--tree-->
                                <div id="ols-tree-div" class="tab-pane fade">
                                    <h4>Related in EFO hierarchy:</h4>
                                    <div id="term-tree" style="height:100%; width:100%; border:1px solid black;overflow: auto;"></div>
                                </div>
                                <!--ols-graph-->
                                <div id="ols-graph-div" class="tab-pane fade">
                                    <div id="expension">
                                        <h4>Additional related terms eg. measurements and biomarkers:</h4>
                                        <div>
                                            <div id="ontology_vis"></div>
                                        </div>
                                    </div>

                                </div>

                                <!--&lt;!&ndash;oxo&ndash;&gt;-->
                                <!--<div id="oxo-div" class="tab-pane fade" >-->
                                    <!--<h4>oxo:</h4>-->
                                    <!--<div>-->
                                        <!--<div id="oxo-vis" style="height:500px; width:500px; border:1px solid black;overflow: auto;"></div>-->
                                    <!--</div>-->
                                <!--</div>-->

                            </div>
                        </div>


                    </div>
                </div>
            </div>

            <!--plot, tables-->
            <div class="col-md-7" id="results-area">
                <!-- List the available tables -->
                <div class="row" style="margin-top:0px">
                    <div id="table-list" class="panel clearfix" style="padding-left:0px;box-shadow:none">
                        <span style="margin-right:10px;font-weight:bold">Available data:</span>
                        <button type="button"
                                class="btn btn-default"
                                style="margin-right:10px;font-weight:bold"
                                onclick="toggle_and_scroll('#locus_panel')">
                    <span class="locus_label">Manhattan plot</span><span class="glyphicon glyphicon-stats"
                                                                         style="color:#398A96;margin-left:10px"></span>
                </button>
                        <button type="button"
                                class="btn btn-default"
                                style="margin-right:10px;font-weight:bold"
                                onclick="toggle_and_scroll('#association_panel')">
                    <span class="association_label">Associations</span><span class="association_count badge"
                                                                             style="background-color: #398A96;margin-left:10px"></span>
                </button>
                        <button type="button"
                                class="btn btn-default"
                                style="margin-right:10px;font-weight:bold"
                                onclick="toggle_and_scroll('#study_panel')">
                    <span class="study_label">Studies</span><span class="study_count badge"
                                                                  style="background-color: #398A96;margin-left:10px"></span>
                </button>
                        <!--<button type="button" class="btn btn-default" style="margin-right:10px;font-weight:bold" onclick="toggle_and_scroll('#diseasetrait_panel')">-->
                        <!--<span class="diseasetrait_label">Traits</span><span class="diseasetrait_count badge" style="background-color: #398A96;margin-left:10px"></span>-->
                        <!--</button>-->
                    </div>
                </div>

                <!-- locus plot -->
                <div class="row" style="margin-top:20px" id="locus-plot-row-loading">
                    <div id="locus_panel" class="panel panel-default">
                        <div class="panel-heading background-color-primary-accent">
                            <h3 class="panel-title">
                                <span class="locus_label">Manhattan plot (plot of catalog associations for selected trait)</span>
                                <span class="glyphicon glyphicon-stats" style="color:#398A96;margin-left:10px"></span>
                            </h3>
                            <span class="pull-right">
                        <span class="clickable panel-collapsed"
                              style="margin-left:25px"
                              onclick="toggleSidebar('#locus_panel span.clickable')">
                            <span class="glyphicon glyphicon-chevron-down"></span>
                        </span>
                    </span>
                        </div>
                        <div class="panel-body" style="display:none">
                            <!--<div class="panel-body" style="display:initial">-->
                            <!-- locus plot -->
                            <!--<div id="plot" style=" width: 1000px; height: 900px;"></div>-->
                            <div id="plot" style=" width: 100%; height: 100%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Associations table -->
                <div class="row" id="association-table-loading" style="margin-top:20px">
                    <div id="association_panel" class="panel panel-default">
                        <div class="panel-heading background-color-primary-accent">
                            <h3 class="panel-title">
                                <span class="association_label">Associations</span><span class="association_count badge"
                                                                                         style="background-color: #398A96;margin-left:10px"></span>
                            </h3>
                            <span class="pull-right">
                        <button type="button" class="btn btn-default btn-xs" id="download_data">
                            <span class="glyphicon glyphicon-download-alt" style="padding-right:2px"></span>
                            <span>Download association data</span>
                        </button>
                        <span class="clickable panel-collapsed"
                              style="margin-left:25px"
                              onclick="toggleSidebar('#association_panel span.clickable')">
                            <span class="glyphicon glyphicon-chevron-down"></span>
                        </span>
                    </span>
                        </div>

                        <div class="panel-body" style="display:none">


                            <table id="association-table" class="table table-striped borderless"
                                   data-flat="true"
                                   data-search="true"
                                   data-show-columns="true"
                                   data-show-multi-sort="true">
                            </table>
                            <!--<table id="association-table" class="table table-striped">-->
                                <!--<thead id="association-table-header">-->
                                <!--<tr>-->
                                    <!--<th style="width: 10%" id="strongestAllele">Risk allele-->
                                        <!--<span class="glyphicon glyphicon-question-sign context-help"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="Variant most strongly associated with trait + risk/effect allele. This may also be haplotype or variant x variant interaction."></span>-->
                                                                                <!--&lt;!&ndash;<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>&ndash;&gt;-->
                                    <!--</th>-->
                                    <!--<th style="width: 8%" id="riskFrequency">RAF-->
                                        <!--<span class="glyphicon glyphicon-question-sign context-help"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="Risk/effect allele frequency in controls"></span>-->
                                        <!--<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>-->
                                    <!--</th>-->
                                    <!--<th style="width: 12%" id="pValue">p-value-->
                                        <!--<span class="glyphicon glyphicon-question-sign context-help"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="p-value for most strongly associated variant, along with any information describing context of p-value"></span>-->
                                        <!--<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>-->
                                    <!--</th>-->
                                    <!--<th style="width: 6%" id="orPerCopyNum">OR-->
                                        <!--<span class="glyphicon glyphicon-question-sign context-help"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="Odds ratio associated with variant"></span>-->
                                        <!--<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>-->
                                    <!--</th>-->
                                    <!--<th style="width: 14%" id="orType">Beta-->
                                        <!--<span class="glyphicon glyphicon-question-sign context-help"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="Beta-coefficient and unit increase/decrease associated with variant"></span>-->
                                        <!--<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>-->
                                    <!--</th>-->
                                    <!--<th style="width: 6%">CI-->
                                        <!--<span class="glyphicon glyphicon-question-sign context-help"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="95% confidence interval for OR or beta"></span>-->
                                    <!--</th>-->

                                    <!--<th style="width: 8%">Reported gene(s)-->
                                        <!--<span class="glyphicon glyphicon-question-sign context-help"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="Gene(s) reported by author"></span>-->
                                    <!--</th>-->

                                    <!--<th style="width: 13%" id="traitName_s-alt">Reported trait-->
                                        <!--<span class="glyphicon glyphicon-question-sign"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="Description of disease/trait analysed in the study"></span>-->
                                        <!--<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>-->
                                    <!--</th>-->
                                    <!--<th style="width: 13%" id="traitName-alt">Mapped trait-->
                                        <!--<span class="glyphicon glyphicon-question-sign"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="Description of disease/trait mapped to the study"></span>-->
                                        <!--<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>-->
                                    <!--</th>-->
                                    <!--<th style="width: 15%" id="author_s-alt" colspan="2">Study-->
                                        <!--<span class="glyphicon glyphicon-question-sign context-help"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="First author and year of publication, along with link to publication in Europe PubMed Central."></span>-->
                                        <!--<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>-->
                                    <!--</th>-->
                                <!--</tr>-->
                                <!--</thead>-->
                                <!--<tbody id="association-table-body"></tbody>-->
                            <!--</table>-->
                        </div>
                    </div>
                </div>

                <!-- Studies table -->
                <div class="row" id="study-table-loading" style="margin-top:20px">
                    <div id="study_panel" class="panel panel-default">
                        <div class="panel-heading background-color-primary-accent">
                            <h3 class="panel-title">
                                <span class="study_label">Studies</span><span class="study_count badge"
                                                                              style="background-color: #398A96;margin-left:10px"></span>
                            </h3>

                            <span class="pull-right clickable panel-collapsed"
                                  onclick="toggleSidebar('#study_panel span.clickable')">
                        <span class="glyphicon glyphicon-chevron-down"></span>
                    </span>
                        </div>

                        <div class="panel-body" style="display:none">
                            <table id="study-table" class="table table-striped borderless"
                                   data-flat="true"
                                   data-search="true"
                                   data-show-columns="true"
                                   data-show-multi-sort="true">
                            </table>
                            <!--<table id="study-table" class="table table-striped">-->
                                <!--<thead id="study-table-header">-->
                                <!--<tr>-->
                                    <!--<th style="width: 12%" id="author_s">Author-->
                                        <!--<span class="glyphicon glyphicon-question-sign context-help"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="First author, along with link to publication in Europe PubMed Central."></span>-->
                                        <!--<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>-->
                                    <!--</th>-->
                                    <!--<th style="width: 10%" id="publicationDate">Date-->
                                        <!--<span class="glyphicon glyphicon-question-sign context-help"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="Publication date (YYYY-MM-DD)"></span>-->
                                        <!--<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>-->
                                    <!--</th>-->
                                    <!--<th style="width: 12%" id="publication">Journal-->
                                        <!--<span class="glyphicon glyphicon-question-sign context-help"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="Abbreviated journal name"></span>-->
                                        <!--<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>-->
                                    <!--</th>-->
                                    <!--<th style="width: 30%" id="title">Title-->
                                        <!--<span class="glyphicon glyphicon-question-sign context-help"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="Title of paper"></span>-->
                                                                      <!--&lt;!&ndash;<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>&ndash;&gt;-->
                                    <!--</th>-->
                                    <!--<th style="width: 12%" id="sample_i">Initial sample description-->
                                        <!--<span class="glyphicon glyphicon-question-sign context-help"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="Description of the initial sample analysed in the study"></span>-->
                                        <!--<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>-->
                                    <!--</th>-->
                                    <!--<th style="width: 12%" id="sample_r">Replication sample description-->
                                        <!--<span class="glyphicon glyphicon-question-sign context-help"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="Description of the replication sample analysed in the study"></span>-->
                                        <!--<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>-->
                                    <!--</th>-->
                                    <!--<th style="width: 12%" id="ancestral_gp">Ancestral groups-->
                                        <!--<span class="glyphicon glyphicon-question-sign context-help"-->
                                              <!--data-toggle="tooltip"-->
                                              <!--data-original-title="List of the ancestral groups analysed in the study"></span>-->
                                        <!--<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>-->
                                    <!--</th>-->
                                <!--</tr>-->
                                <!--</thead>-->
                                <!--<tbody id="study-table-body"></tbody>-->
                            <!--</table>-->
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>




    <!--<div data-name="dock" data-smarti="dock" data-dock-position="left"-->
         <!--data-dock-offset="20" style="width:100%; height:90%; margin:0px">-->

        <!--<div data-dock="true" style="width:50%; background-color:#f5f5f5; border-right:1px solid #ddd; padding:20px; overflow:scroll">-->
        <!--aaa-->
        <!--</div>-->
        <!--<div data-handle="true" class="h" style="left:-18px;"> <span class="glyphicon glyphicon-backward"></span></div>-->
        <!--<div data-handle="hidden" class="h" style="left:-15px;"><span class="glyphicon glyphicon-forward"></span></div>-->
        <!--<div data-content="true" style=" padding:20px;">-->
            <!--bbb-->
        <!--</div>-->
    <!--</div>-->




</div>

<!--Include footer-->
<div th:include="fragments/footer :: page_footer"></div>


<!-- Bootstrap core JavaScript
    ================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>


<script src="../static/js/bootstrap.min.js" th:src="@{../../js/bootstrap.min.js}"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.0/bootstrap-table.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.0/bootstrap-table.css"
      th:href="@{https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.0/bootstrap-table.css}"
      rel="stylesheet"/>



<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="../static/js/ie10-viewport-bug-workaround.js"
        th:src="@{../../js/ie10-viewport-bug-workaround.js}"></script>
<script>
    $(document).ready(function() {
        $('[data-toggle="tooltip"]').tooltip();
    });
</script>

<!-- GOCI JavaScript
================================================== -->
<script src="../static/js/goci-ui.js" th:src="@{../../js/goci-ui.js}"></script>
<script src="../static/js/efotraitresult.js" th:src="@{../../js/efotraitresult.js}"></script>

<!-- LocusZoom
================================================== -->
<script src="../static/js/plugins/locuszoom.vendor.min.js"
        th:src="@{../../js/plugins/locuszoom.vendor.min.js}"></script>
<script src="../static/js/plugins/locuszoom.app.js" th:src="@{../../js/plugins/locuszoom.app.js}"></script>
<link rel="stylesheet" href="../static/css/locuszoom.css" th:href="@{../../css/locuszoom.css}"/>

<!-- clipboardjs
================================================== -->
<script src="../static/js/plugins/clipboard.min.js" th:src="@{../../js/plugins/clipboard.min.js}"></script>

<!-- OLS-tree
================================================== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
<script src="../static/js/plugins/ols-treeview.js" th:src="@{../../js/plugins/ols-treeview.js}"></script>
<link rel="stylesheet"
      href="../static/css/proton/style.min.css"
      th:href="@{../../css/proton/style.min.css}"
      media="screen"/>

<!-- OLS auto-suggest
================================================== -->
<link rel="stylesheet" href="../static/css/ols_auto_complete/ols.css" th:href="@{../../css/ols_auto_complete/ols.css}"/>
<link rel="stylesheet"
      href="../static/css/ols_auto_complete/ols-colors.css"
      th:href="@{../../css/ols_auto_complete/ols-colors.css}"/>
<link rel="stylesheet"
      href="../static/css/ols_auto_complete/typeaheadjs.css"
      th:href="@{../../css/ols_auto_complete/typeaheadjs.css}"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/corejs-typeahead/0.11.1/typeahead.bundle.min.js"></script>
<script src="../static/js/plugins/ols-autocomplete.js" th:src="@{../../js/plugins/ols-autocomplete.js}"></script>

<!-- OLS-graph
================================================== -->
<link rel="stylesheet"
      href="../static/css/ols_graph/awesomplete.css"
      th:href="@{../../css/ols_graph/awesomplete.css}"
      type="text/css"/>
<link rel="stylesheet"
      href=".../static/css/ols_graph/OLS-graphview.css"
      th:href="@{../../css/ols_graph/OLS-graphview.css}"
      type="text/css"
      media="screen"/>
<link rel="stylesheet"
      href="../static/css/ols_graph/vis.min.css"
      th:href="@{../../css/ols_graph/vis.min.css}"
      type="text/css"/>
<script src="../static/js/plugins/ols-graphview.js" th:src="@{../../js/plugins/ols-graphview.js}"></script>

<!--vis.js-->
<script src="https://cdn.rawgit.com/almende/vis/master/dist/vis.js"></script>

<!--semantic ui for sidebar-->
<!--<script src="https://cdn.rawgit.com/Semantic-Org/UI-Sidebar/master/sidebar.js"></script>-->
<!--<link rel="stylesheet" href="https://cdn.rawgit.com/Semantic-Org/UI-Sidebar/master/sidebar.css" type="text/css"></link>-->
<!--<script src="http://tab-slide-out.googlecode.com/files/jquery.tabSlideOut.v1.3.js"></script>-->
<script src="https://cdn.rawgit.com/nnattawat/slideReveal/master/dist/jquery.slidereveal.js"></script>


<!--oxo-grapg-->
<script src="../static/js/plugins/oxo-graph.js" th:src="@{../../js/plugins/oxo-graph.js}"></script>

<!-- loading overlay
================================================== -->
<script src="https://cdn.jsdelivr.net/jquery.loadingoverlay/latest/loadingoverlay.min.js"></script>

<!--bootstrap-table-flat-json-->
<script src="https://cdn.rawgit.com/wenzhixin/bootstrap-table/develop/dist/extensions/flat-json/bootstrap-table-flat-json.js"></script>
<script src="https://cdn.rawgit.com/wenzhixin/bootstrap-table/develop/dist/extensions/multiple-sort/bootstrap-table-multiple-sort.js"></script>


<!-- trait page
================================================== -->
<script src="../static/js/efotrait-locuszoom.js" th:src="@{../../js/efotrait-locuszoom.js}"></script>
<script src="../static/js/efotrait-util.js" th:src="@{../../js/efotrait-util.js}"></script>

<script type="text/javascript">
//   var $table = $('#table');
//   var mydata =
//           [
//               {
//                   "id": 0,
//                   "name": "test0",
//                   "price": "$0"
//               },
//               {
//                   "id": 1,
//                   "name": "test1",
//                   "price": "$1"
//               },
//               {
//                   "id": 2,
//                   "name": "test2",
//                   "price": "$2"
//               },
//               {
//                   "id": 3,
//                   "name": "test3",
//                   "price": "$3"
//               },
//               {
//                   "id": 4,
//                   "name": "test4",
//                   "price": "$4"
//               },
//               {
//                   "id": 5,
//                   "name": "test5",
//                   "price": "$5"
//               },
//               {
//                   "id": 6,
//                   "name": "test6",
//                   "price": "$6"
//               },
//               {
//                   "id": 7,
//                   "name": "test7",
//                   "price": "$7"
//               },
//               {
//                   "id": 8,
//                   "name": "test8",
//                   "price": "$8"
//               },
//               {
//                   "id": 9,
//                   "name": "test9",
//                   "price": "$9"
//               },
//               {
//                   "id": 10,
//                   "name": "test10",
//                   "price": "$10"
//               },
//               {
//                   "id": 11,
//                   "name": "test11",
//                   "price": "$11"
//               },
//               {
//                   "id": 12,
//                   "name": "test12",
//                   "price": "$12"
//               },
//               {
//                   "id": 13,
//                   "name": "test13",
//                   "price": "$13"
//               },
//               {
//                   "id": 14,
//                   "name": "test14",
//                   "price": "$14"
//               },
//               {
//                   "id": 15,
//                   "name": "test15",
//                   "price": "$15"
//               },
//               {
//                   "id": 16,
//                   "name": "test16",
//                   "price": "$16"
//               },
//               {
//                   "id": 17,
//                   "name": "test17",
//                   "price": "$17"
//               },
//               {
//                   "id": 18,
//                   "name": "test18",
//                   "price": "$18"
//               },
//               {
//                   "id": 19,
//                   "name": "test19",
//                   "price": "$19"
//               },
//               {
//                   "id": 20,
//                   "name": "test20",
//                   "price": "$20"
//               }
//           ];
//
//   $(function () {
//       $('#table').bootstrapTable({
//                                      columns: [{
//                                          field: 'id',
//                                          title: 'Item ID'
//                                      }, {
//                                          field: 'name',
//                                          title: 'Item Name'
//                                      }, {
//                                          field: 'price',
//                                          title: 'Item Price'
//                                      }],
//                                      data: mydata
//
//                                  });
//   });
//
//   $(function () {
//
//   });
</script>

<!--local data-->
<script th:inline="javascript">
    /*<![CDATA[*/


    var data_efo=undefined
    var data_study=undefined
    var data_association=undefined
    var data_diseasetrait=undefined
    var data_facet=undefined
    var data_highlighting=undefined


    $('#btn-query-include-descendants').click(function() {
        //replot with all children, from the currently selected efos
        addEFO({}, false, true);
    });

    $('#btn-clear-highlight').click(function() {
        $('.list-group-item').removeClass("highlight");
        reloadLocusZoom('#plot', data_association);
    });

    $('#btn-clear-cart').click(function() {
        var selected = getDataFromTag(global_efo_info_tag_id, 'selectedEfos')
        var mainEFO = getMainEFO();
        Object.keys(selected).map(function(key){
            if(key != mainEFO)
                removeDataFromTag(global_efo_info_tag_id,'selectedEfos',key)
        })

        whichDescendant().map(function(key){
            removeDataFromTag(global_efo_info_tag_id,'whichDescendant',key)
        })
        addEFO({}, false);
    });

    $('#btn-query-include-related-terms').click(function() {
        //replot with all related terms, from the currently selected efos
        getRelatedTerms(getMainEFO()).then(function(data) {
            addEFO(data, false);
        });
    });

    $('#ols-link').click(function() {
        getOLSLink(getMainEFO()).then(function(link){
            window.open(link, '_blank');
        })
    });

    $('#oxo-link').click(function() {
            window.open("http://www.ebi.ac.uk/spot/oxo/terms/" + getMainEFO() , '_blank');
    });




    $("#cb-query-include-descendants").change(function() {
        addEFO({},false,$("#cb-query-include-descendants").is(":checked"));
    });

    $(document).ready(function() {
        //add beta icon
        if (window.location.pathname.indexOf("beta") != -1) {
            $('#beta-icon').show();
        }
        //jump to the top of the page
        $('html,body').scrollTop(0);

        var searchTerm = getMainEFO();
        var included = $('#included').text();
        if (included != '') {
            searchTerm = searchTerm + ',' + included;
        }
        console.log("Loading search module!");
        if (searchTerm != '') {
            console.log("Start search for the efotrait " + searchTerm);
            var elements = {};
            searchTerm.split(',').forEach(function(term) {
                                              elements[term] = term;
                                          }
            )
            //xintodo first load
            addEFO(elements, true);
        }
    });

    //When adding extra term to the cart
    addEFO = function(data, initLoad) {
        if(initLoad==undefined)
            initLoad = false;

        //load all available efo terms in the GWAS Catalog(has at least one annotation)
        //save in the global_efo_info_tag_id tag with key 'availableEFOs'
        var p = getAvailableEFOs();

        var selected = addDataToTag(global_efo_info_tag_id, data, 'selectedEfos')

        Promise.all(Object.keys(data).map(getHierarchicalDescendants)).then(function(data) {
            console.log('finish loading descendants!')
        });

        // p is the promise for loading all available efo from GWAS Catalog
        // This needs to be fullfill before trigger any add event.
        p.then(function(data) {
            $(global_efo_info_tag_id).trigger('addToSelect', [initLoad]);
        }).catch(function(err) {
            console.error('Error when loading all available EFOs ' + err)
        });
    }

    //remove an efo term from the cart
    removeEFO = function(efoid) {
        removeDataFromTag(global_efo_info_tag_id,'selectedEfos',efoid)
        removeDataFromTag(global_efo_info_tag_id,'whichDescendant',efoid)
        addEFO({},false);
    }



    //triger a refresh of the page content, including locusplot, tables, badges.
    updatePage = function(initLoad) {

        //start spinner. The spinner will be stoped whenever the data is ready, thus closed by the coresponding data loading function.
        if(initLoad){
            showLoadingOverLay('#summary-panel-loading');
//            showLoadingOverLay('#highlight-study-panel-loading');
        }
        showLoadingOverLay('#locus-plot-row-loading');
        showLoadingOverLay('#association-table-loading');
        showLoadingOverLay('#study-table-loading');
        showLoadingOverLay('#cart-loading');
        showLoadingOverLay('#sharable_link_btn');


        var current_select = getCurrentSelected();
        var mainEFO = getMainEFO();


        if(isAlwaysDescendant()){
            addDataToTag(global_efo_info_tag_id, getCurrentSelected(), 'whichDescendant')
        }


        // ******************************
        // update cart box
        // ******************************
        var container = $('#cart');
        container.empty()
        //update cart, the badge will be 0 since the data is not ready at this stage.
        var updateSelectedBoxPromise = Object.keys(current_select).map(getEFOInfo).reduce(function(sequence, efoInfo) {
            return sequence.then(function() {
                return efoInfo;
            }).then(function(efoInfo) {
                return addToCart('#cart', efoInfo.short_form, '['+efoInfo.short_form+'] '+efoInfo.label).then(function(){
                    return efoInfo;
                })

            });
        }, Promise.resolve()).catch(function(err) {
            console.warning('Error when updating cart! ' + err);
        }).then(
                //hideLoadingOverLay('#cart-loading')
        );


        //******************************
        // update efo information panel
        //******************************
        if (initLoad){
            //display efo trait information when data is ready
            displayEfoTraitInfo(mainEFO);
        }

        //******************************
        // add ols graph for related term
        //******************************
        if (initLoad) {
            //addRelatedTermCheckBox();
            addRelatedTermGraph(mainEFO);
        }

        //******************************
        // update shareable link
        //******************************
        updateSharableLink();

        //******************************
        // query descendants for current selected terms
        //******************************
        var all_descendants = {}
        var desPromise = Promise.all(whichDescendant().map(getHierarchicalDescendants)).then(function(descendants) {
            descendants.forEach(function(terms) {
                Object.keys(terms).forEach(function(term) {
                    all_descendants[term] = terms[term];
                })
            })
            return all_descendants;
        }).catch(function(err) {
            console.warning('Error when trying to find all descendants with error messgae ' + err);
        })


        //******************************
        // when solr data ready, process solr data and update badges in the selection cart
        //******************************
        Promise.all([updateSelectedBoxPromise,desPromise]).then(function(arr){
            var solrPromise = getEfoTraitDataSolr(mainEFO, Object.keys(current_select), Object.keys(all_descendants), initLoad);
            solrPromise.then(function(){

                //update selection cart
                Object.keys(current_select).map(getEFOInfo).reduce(function(sequence, efoInfo) {
                    return sequence.then(function() {return efoInfo;}).then(function(efoInfo){
                        var target_efos;
                        if(isDescendantRequired(efoInfo.short_form)){
                            //self and decendants
                            target_efos = getHierarchicalDescendants(efoInfo.short_form).then(function(data){
                                //adding self
                                return Object.keys(data).concat(efoInfo.short_form);
                            })
                        }else{
                            //only self
                            target_efos = Promise.resolve([efoInfo.short_form]);
                        }

                        target_efos.then(function(efos){
                            //update the selection box badge number when data is ready
                            $('#' + 'selected_btn_' + efoInfo.short_form + '_nos').attr('text', Object.keys(findStudiesForEFOs(efos)).length)
                            $('#' + 'selected_btn_' + efoInfo.short_form + '_nos').html(Object.keys(findStudiesForEFOs(efos)).length)
                            $('#' + 'selected_btn_' + efoInfo.short_form + '_noa').attr('text', Object.keys(findAssociationForEFOs(efos)).length)
                            $('#' + 'selected_btn_' + efoInfo.short_form + '_noa').html(Object.keys(findAssociationForEFOs(efos)).length)
                            //work out what association is included (self or self+descendants), this is used for highlighting the plot.
                            $('#' + 'selected_btn_' + efoInfo.short_form + '_noa').data('associations', findAssociationForEFOs(efos))
                        });
                    })
                },Promise.resolve())


            }).catch(function(err) {
                console.error('Error search solr. ' + err);
                $('#lower_container').html("<h2>Solr server is not available. Please try again later.</h2>");
            }).then(function(){
                hideLoadingOverLay('#cart-loading');
            })
        });
    }



    $(global_efo_info_tag_id).on('addToSelect', function(e, initLoad) {
        updatePage(initLoad);
    });


    /**
     * function to add a selected efo to the cart box on the page,
     * add bagdes to indicate the the toplevel efo and the number of association/trait for this efo
     * add checkkbox to indicate the descendants
     */
    addToCart = function(tagID, efoid, additionalLabel) {

        var isMain = isMainEFO(efoid);

        var colour, colourLabelInit,colourLabel;
        //add badge to the cart item to show the toplevel efo and the number of association/trait for this efo
        return getColourForEFO(efoid).then(function(data){
            colour = data.colour;
            colourLabelInit = data.colourLabel.substr(0,1)
            colourLabel = data.colourLabel;
        }).catch(function(err){
            //if colour server is not available
            console.warn('Error loading colour for cart item <' + efoid + '>. from ' + global_color_url + '. ' + err + '. Using default colour.')
            //default value
            colour = '#808080';
            colourLabelInit = '?'
            colourLabel = 'unable to reach colour server.';
        }).then(function(){
            var container = $(tagID);

            //checkbox idicate require descendant
            var cb = $('<input />', { id: 'selected_cb_' + efoid , type: 'checkbox',class:"cart-item-cb align-middle checkbox col-xs-1 col-sm-1 col-md-1 col-lg-1", value:efoid}).css({'float':'left','margin-top':'15px'}).appendTo(container);
            if (isDescendantRequired(efoid)){
                cb.attr('checked','checked')
            }

            cb.change(function(){
                //xintodo update the plot
                var id=this.id.split("selected_cb_")[1];

                if(this.checked){
                    var tmp = {};
                    tmp[id] = 1;
                    addDataToTag(global_efo_info_tag_id, tmp, 'whichDescendant')
                }else{
                    var tmp = getDataFromTag(global_efo_info_tag_id,'whichDescendant');
                    delete tmp[id];
                }
                $(global_efo_info_tag_id).trigger('addToSelect', [false]);
            })

            if(isAlwaysDescendant()){
                cb.attr("disabled", true);
            }else{
                cb.removeAttr("disabled");
            }

            //cart item
            var item = $('<a />', {
                class: 'list-group-item col-xs-11 col-sm-11 col-md-11 col-lg-11',
            }).css({
                       'overflow': 'hidden', 'white-space': 'nowrap;', 'text-overflow': 'ellipsis', 'color' :'black'
                   }).appendTo(container);


            $('<span />', { class: 'badge', text: colourLabelInit, title:colourLabel})
                    .css({'background-color' :colour,'margin-right': '0.3em','color':'black', 'float': 'left'})
                    .appendTo(item);



            //Add a 'x' to item than can be remove from cart, this will be all terms except the mainEFO
            if (!isMain) {
                var span = $('<span />', {id: 'selected_btn_' + efoid, class: 'badge', text: '  X  '}).appendTo(item);
                span.on("click", function(e) {
                    removeEFO(efoid);
                });
            }

            // This will add badge at the end of each cart item, showing the number of association/study linked.
            // This will be init probably before the association/study data is available, thus generating badges with
            // '-' as value at the beginning. The badge will be update when the data is available.
            $('<span />', { id: 'selected_btn_' + efoid + '_nos' ,class: 'badge', text: '-' , title:'Number of study'}).css({'color':'white'}).appendTo(item);
            $('<span />', { id: 'selected_btn_' + efoid + '_noa', class: 'badge', text: '-' , title:'Number of association'}).css({'color':'white'}).appendTo(item);


            //to highlight associations only for this efo term
            item.click(function() {
                //TOGGLE HIGHLIGHT
                if(item.hasClass("highlight")){
                    item.removeClass("highlight");
                    reloadLocusZoom('#plot', data_association)
                }else{
                    $('.list-group-item').removeClass("highlight");
                    item.addClass("highlight");
                    var highlightAssociations = $('#selected_btn_' + efoid + '_noa').data('associations')
                    reloadLocusZoom('#plot', data_association, Object.keys(highlightAssociations));
                }

                if(isAlwaysDescendant()){
                    cb.attr("disabled", true);
                }else{
                    cb.removeAttr("disabled");
                }
            })

            item.append(additionalLabel)
            return '';
        })
    }



    //make solr query
    function getEfoTraitDataSolr(mainEFO, additionalEFO, descendants, initLoad) {
        // initLoad will be pass to processEfotraitData, controlling whether to upload the triat information(initload)
        // or just reload the tables(adding another efo term)
        if (initLoad === undefined) {
            initLoad = false;
        }

        var searchQuery = mainEFO;


        if (additionalEFO.length > 0) {
            var p1 = filterAvailableEFOs(additionalEFO).then(function(additionalEFO_filtered) {
                if (additionalEFO_filtered.length > 0)
                    return searchQuery = searchQuery + ',' + additionalEFO_filtered.join(',');
                else
                    return searchQuery;
            });

        }

        if (descendants.length > 0) {
            var p2 = filterAvailableEFOs(descendants).then(function(descendants_filtered) {
                if (descendants_filtered.length > 0)
                    searchQuery = searchQuery + ',' + descendants_filtered.join(',');
                else
                    return searchQuery;
            });
        }

        //xintodo the url will be too long if there are a lot of terms to query, maybe change to post?
        return Promise.all([p1, p2]).then(function() {
            console.log("Solr research request received for " + searchQuery);
            return promiseGet('/gwas/api/search/efotrait',
                              {
                                  'q': searchQuery,
                                  'max': 9999,
                                  'group.limit': 9999,
                                  'group.field': 'resourcename',
                                  'facet.field': 'resourcename',
                                  'hl.fl': 'shortForm,efoLink',
                                  'hl.snippets': 100
                              }).then(JSON.parse).then(function(data) {
                processEfotraitData(data, mainEFO, initLoad);
                console.log("Solr research done for " + searchQuery);
                return data;
            }).catch(function(err) {
                console.error('Error when seaching solr for' + searchQuery + '. ' + err);
                throw(err);
            })
        })

    }


    //Parse the Solr results and display the data on the HTML page
    function processEfotraitData(data, efotraitId, initLoad) {
        // Check if Solr returns some results
        if (data.grouped.resourcename.matches == 0) {
            $('#lower_container').html("<h2>The efotrait <em>" + efotraitId +
                                       "</em> cannot be found in the GWAS Catalog database</h2>");
        }
        else {
            //split the solr search by groups
//            data_efo, data_study, data_association, data_diseasetrait;
            data_facet = data.facet_counts.facet_fields.resourcename;
            data_highlighting = data.highlighting;

            $.each(data.grouped.resourcename.groups, function(index, group) {
                switch (group.groupValue) {
                    case "efotrait":
                        data_efo = group.doclist;
                        break;
                    case "study":
                        data_study = group.doclist;
                        break;
                    case "association":
                        data_association = group.doclist;
                        break;
                        //not sure we need this!
                    case "diseasetrait":
                        data_diseasetrait = group.doclist;
                        break;
                    default:
                }
            });

            //update association/study table
            displayEfotraitAssociations(data_association.docs);
            displayEfotraitStudies(data_study.docs);


            //work out highlight study
            var highlightedStudy = findHighlightedStudiesForEFO(getMainEFO());
            if(initLoad){
                displayHighlightedStudy(highlightedStudy);
                //display summary information like 'EFO trait first reported in GWAS Catalog in 2007, 5 studies report this efotrait'
                getSummary(findStudiesForEFO(getMainEFO()));
            }


            //we add preferEFO for each association, generate the association data in popup for locus plot.
            var allUniqueEFO = {}
            data_association.docs.forEach(function(d, i) {
                var traits = _findAllEFOsforAssociation(d.id,data);
                d.preferedEFO = _findhighlightEFOForAssociation(traits, d.id);
                allUniqueEFO[d.preferedEFO] = '';
                //add any string data that will be use in the locus plot popover
                d.popoverHTML = buildLocusPlotPopoverHTML(d);
            })

            //query for distinct efo terms. This will reduce the query number so work faster
//            {
//                uri: "http://www.ebi.ac.uk/efo/EFO_0000400",
//                        trait: "diabetes mellitus",
//                    parentUri: "http://www.ebi.ac.uk/efo/EFO_0000589",
//                    parent: "metabolic disease",
//                    colour: "#FDB462"
//            }
            //Load colour for unique efo
            var allColorLoaded = []
            Object.keys(allUniqueEFO).forEach(function(efo) {
                allColorLoaded.push(getColourForEFO(efo).then(function(response) {
                    allUniqueEFO[efo] = response;
                    return response;
                }));
            })

            //When all colour are received, replot
            Promise.all(allColorLoaded).then(function() {
                                                 //assign colour to associations for plot
                                                 console.log('Finish loading color from ' + global_color_url);
                                                 console.log(allUniqueEFO);
                                                 data_association.docs.forEach(function(d, i) {
                                                     d.preferedColor = allUniqueEFO[d.preferedEFO].colour;
                                                     d.preferedParentUri = allUniqueEFO[d.preferedEFO].parentUri;
                                                     d.preferedParentLabel = allUniqueEFO[d.preferedEFO].parent;
                                                     d.category = allUniqueEFO[d.preferedEFO].parent;
                                                 })
                                             }
            ).catch(function(err) {
                console.warn('Error loading colour for Locus zoom plot from ' + global_color_url + '. ' + err + '. Using default colour.')
                //xintodo create a default colour to plot, if the colour query fail
            }).then(function(){
                reloadLocusZoom('#plot', data_association);
            });
        }
    }


    //checkbox approach
    addRelatedTermCheckBox = function() {
        function addCheckbox(id, name, cbclass) {
            var container = $('#expension');
            $('<input />', {type: 'checkbox', id: id, class: cbclass, value: name}).appendTo(container);
            $('<label />', {'for': id, text: name}).appendTo(container);
            $('<div />', {'id': 'why' + id}).appendTo(container);

            $('<br />').appendTo(container);

        }

        getRelatedTerms(getMainEFO()).then(function(terms) {
            //make checkbox
            Object.keys(terms).forEach(function(relatedTerm) {
                var d = terms[relatedTerm];
                addCheckbox('cb' + d.obo_id, d.obo_id + ' : ' + d.label, 'efocheckbox');
                $("#" + 'whycb' + d.obo_id).html(d.logical_description);
                if (d.obo_id == getMainEFO()) {
                    $("#cb" + d.obo_id).attr("checked", true);
                }
            })

            //add check event.
            $(".efocheckbox").change(function() {
                var elements = {};
                $('.efocheckbox:input:checked').each(function(cb) {
                    elements[$(this).attr('value').split(" : ")[0]] = $(this).attr('value').split(" : ")[1];
                });
                addEFO(elements);
            });
        })
    }

    addRelatedTermGraph = function(mainEFO) {

        var mainEFOLink = getOLSLinkAPI(mainEFO).then(function(termFullLink) {
            return termFullLink + '/graph';
        })

        var mainEFOIri = getIriByShortForm(mainEFO)

        var tmpnetworkOptions = {
            webservice: {
//            URL: "http://www.ebi.ac.uk/ols/api/ontologies/cmpo/terms/http%253A%252F%252Fpurl.obolibrary.org%252Fobo%252FCHEBI_33839/graph",
                OLSschema: false
            },
            displayOptions: {showButtonBox: true, showInfoWindow: false, showLegend: true},
            callbacks: {
                onSelectNode: function(params) {
                    console.log(params);
                },
                onDoubleClick: function(params) {
                    console.log(params);
                    var node = params.nodes[0];
                    var efoid = node.split('/').slice(-1)[0];
                    var tmp = {}
                    tmp[efoid] = node;
                    addEFO(tmp);
                },
                onSelectEdge: function(params) {
                    console.log(params);
                },
                onClick: function(params) {
                    console.log(params);
                }
            }
        }
        var visoptions = {
            physics: {
                forceAtlas2Based: {
                    gravitationalConstant: -50,
                    centralGravity: 0.01,
                    springConstant: 0.08,
                    springLength: 100,
                    damping: 0.4,
                    avoidOverlap: 0
                },
            },
            layout: {
                hierarchical: false
            },
            nodes: {
                borderWidth: 4,
                shape: 'ellipse'
            },
            edges: {
                arrows: {middle: {enabled: true}},
                dashes: true,
            },
        }

        var term = "Can be whatever at the moment - if you chose OLSschema false"
        var app = require("ols-graphview");
        var instance = new app();

        var reasonForRelatedEFO = {};

        mainEFOLink.then(function(mainLink) {
            tmpnetworkOptions['webservice']['URL'] = mainLink;

            instance.visstart("ontology_vis", term, tmpnetworkOptions, visoptions);

            getRelatedTerms(getMainEFO()).then(function(terms) {

                Object.keys(terms).forEach(function(relatedTerm) {
                    var d = terms[relatedTerm];
                    reasonForRelatedEFO[d.obo_id] = d.logical_description;
                })

                return Object.keys(terms).map(getOLSLinkAPI).reduce(function(sequence, termOLSLinkPromise) {
                    return sequence.then(function() {
                        return termOLSLinkPromise;
                    }).then(function(termOLSLink) {
                        //for each related term, add it to the graph
                        instance.fetchNewGraphData(termOLSLink + '/graph');
                    })
                }, Promise.resolve())
            })
        }).then(function() {
            var x = instance.getGraphDataset()
            var net=instance.getNetwork()
            console.log(net)

            //change mainEFO node shape
            mainEFOIri.then(function(iri) {
                net.once("stabilized", function(params){
                    //http://visjs.org/docs/data/dataset.html
                    var defaultAttribute = x["nodes"].get(iri)
                    defaultAttribute.color.border = 'blue';
                    x["nodes"].update(defaultAttribute);

                    //add why to the title of node
                    $.each(reasonForRelatedEFO, function(efoid, reason) {
                        getIriByShortForm(efoid).then(function(iri) {
                            x["nodes"].update({id: iri, title: reason});
                        })
                    })
                })
            })
        }).catch(function(err) {
            console.error('Error when plotting related terms.' + err);
        })

    }


    /*]]>*/



</script>



<script>
    //<![CDATA[
    var smarti = this['smarti'] || { scope: this };

    $(function () {
        if (!smarti.initialized) {
            smarti.initialized = true;
            $('[data-smarti]').smarti();
        }
    })

    $.fn.smarti = function () {
        $.each(this.selector == '[data-smarti]' ? this : this.find('[data-smarti]'), function () {
            var jq = $(this);
            var opts = jq.data();
            smarti.scope[opts.name] = new smarti[opts['smarti']](jq, opts);
        });
    }

    smarti.dock = function (jq, opts) {
        var that = this;
        this.dockPosition = 'left';
        this.dockOffset = 10;
        this.container = jq.css({ overflow: 'hidden' });
        $.extend(that, opts);

        if (this.container.css('position') != 'absolute') this.container.css({ position: 'relative' });
        this.dock = this.container.children('[data-dock]').css({ position: 'absolute', zIndex: 999 });
        this.handle = this.container.children('[data-handle]').css({ position: 'absolute', zIndex: 1000 });
        this.content = this.container.children('[data-content]').css({ position: 'absolute', top: 0, right: 0, bottom: 0, left: 0 });
        this._storage = this.useStorage != null ? this.useStorage + 'Storage' : null;
        if (this.container.height() == 0) {
            this._autoHeight = true;
            this.content.css({ bottom: 'auto' });
        }

        this._ap = function () { return that.dockPosition == 'left' || that.dockPosition == 'right' ? ['top', 'bottom'] : ['left', 'right'] }
        this._ds = function () { return that._ap()[0] == 'top' ? that.dock.outerWidth(true) : that.dock.outerHeight(true) }

        this._setHover = function () {
            if (!that.docked) {
                that.dock.mouseover(function () {
                    if (!that._sliding && !that._hover) {
                        that._sliding = true;
                        that._hover = true;
                        that.slide(function () { that._sliding = false; });
                    }
                });
                that.content.mouseover(function () {
                    if (!that._sliding && that._hover) {
                        that._sliding = true;
                        that._hover = false;
                        that.slide(function () { that._sliding = false; });
                    }
                });
            }
            else {
                that._hover = false;
                that.dock.off('mouseover');
                that.content.off('mouseover');
            }
        }
        this._setDocked = function (docked) {
            that.docked = docked;
            if (that._storage != null && smarti.scope[that._storage] != null) smarti.scope[that._storage][that.name + 'Docked'] = docked ? '1' : '0';
        }
        this._getDocked = function () {
            var d = that._storage != null && smarti.scope[that._storage] != null ? smarti.scope[that._storage][that.name + 'Docked'] : null;
            return d != null ? d == '1' : (that.docked != null ? that.docked : true);
        }
        this._fixHeight = function () {
            if (that._autoHeight) {
                var ds = !that.fixedContent && that._ap()[0] == 'left' ? (that.docked ? that._ds() : that.dockOffset) : 0;
                that.container.height(that.content.outerHeight(true) + ds);
            }
        }
        this.toggle = function () {
            that._setDocked(!that.docked);
            if (!that.fixedContent) {
                var o = {};
                o[that.dockPosition] = that.docked ? that._ds() : that.dockOffset;
                that.content.animate(o);
            }
            if (that.docked) that._fixHeight();
            that.slide(function () { that._setHover(); that.toggleHandle(); if (!that.docked) that._fixHeight(); });
        }
        this.toggleHandle = function () {
            if (that.handle.length > 1) {
                that.handle.not("[data-handle='hidden']").toggle(that.docked);
                that.handle.filter("[data-handle='hidden']").toggle(!that.docked);
            }
        }
        this.slide = function (cb) {
            var o1 = {}, o2 = {}; ds = that._ds();
            o1[that.dockPosition] = that.docked || that._hover ? 0 : -ds + that.dockOffset;
            that.dock.animate(o1, cb);
            that.handle.each(function () {
                var jq = $(this);
                var o = jq.data('o');
                o2[that.dockPosition] = that.docked || that._hover ? ds + o : o + that.dockOffset;
                jq.animate(o2);
            });
        }
        this.docked = this._getDocked();
        this.dock.css(this.dockPosition, this.docked ? 0 : -this._ds() + that.dockOffset);
        if (!this.fixedContent) {
            this.content.css(this.dockPosition, this.docked ? this._ds() : that.dockOffset);
            this.dock.css(this._ap()[0], 0).css(this._ap()[1], 0);
        }
        this.handle.each(function () {
            var jq = $(this);
            var o = parseInt(jq.css(that.dockPosition)) || 0;
            jq.data('o', o);
            jq.css(that.dockPosition, that.docked ? that._ds() + o : o + that.dockOffset);
        });
        this.handle.click(this.toggle);
        this._fixHeight();
        this._setHover();
        this.toggleHandle();
        return this;
    }

    //]]>
</script>


<style type="text/css">
    .cart-item-cb  {
        transform:scale(2, 2);
        margin-top: 15px;
    }

    #cart {
        max-height: 300px;
        overflow-y:scroll;
    }

    #cb-query-include-descendants {
        transform:scale(2, 2);
    }

    .list-group-item.highlight {
        background-color: #ffe6f0
    }

</style>

<script>

    //<![CDATA[

    //]]>

</script>


</body>
</html>
<!--//EFO:0000400-->
<!--//    http://localhost:8280/gwas/beta/efotrait/EFO_0000400-->
<!--https://wwwdev.ebi.ac.uk/gwas/beta/rest/docs/index-->
<!--https://wwwdev.ebi.ac.uk/gwas/beta/rest/api/efoTraits/search-->
<!--https://wwwdev.ebi.ac.uk/gwas/beta/rest/api/efoTraits-->
<!--https://wwwdev.ebi.ac.uk/gwas/beta/rest/api-->
<!--https://wwwdev.ebi.ac.uk/gwas/beta/rest/api/efoTraits/71-->
<!--https://wwwdev.ebi.ac.uk/gwas/beta/rest/api/efoTraits/search/findByUri?uri=http://www.ebi.ac.uk/efo/EFO_0000400-->
<!--https://michigangenomics.org/genetic_data.html-->
<!--https://github.com/statgen/locuszoom/wiki/Data-Sources-->
<!--http://wwwdev.ebi.ac.uk/gwas/beta/rest/api/parentMapping/EFO_0000400-->
<!--xintodo get request too long-->
