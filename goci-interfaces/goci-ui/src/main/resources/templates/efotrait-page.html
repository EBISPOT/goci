<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="description"
          content="The NHGRI-EBI GWAS Catalog: a curated collection of all published genome-wide association studies, produced by a collaboration between EMBL-EBI and NHGRI"/>
    <meta name="keywords" content="GWAS Catalog, GWAS, NHGRI, EBI, EMBL-EBI, SPOT"/>
    <meta name="author" content="Tony Burdett, Emma Hastings, Dani Welter, SPOT, EMBL-EBI, NHGRI"/>
    <link rel="icon" href="../static/images/favicon.ico" th:href="@{images/favicon.ico}"/>

    <title>GWAS Catalog</title>
    <!-- Bootstrap core CSS -->
    <link href="../static/css/bootstrap.css" th:href="@{../../css/bootstrap.min.css}" rel="stylesheet"/>
    <!--xintodo disable for offline debug-->
    <!--<link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css"-->
    <!--rel="stylesheet"/>-->
    <link href="../static/css/bootstrap-table.css" th:href="@{../../css/bootstrap-table.css}" rel="stylesheet"/>
    <link href="../static/css/bootstrap-theme.css" th:href="@{../../css/bootstrap-theme.min.css}" rel="stylesheet"/>

    <!-- Custom styles for this template -->
    <link href="../static/css/jumbotron.css" th:href="@{../../css/jumbotron.css}" rel="stylesheet"/>
    <link href="../static/css/sticky-footer-navbar.css"
          th:href="@{../../css/sticky-footer-navbar.css}"
          rel="stylesheet"/>

    <!-- Additional styling on top of bootstrap -->
    <link rel="stylesheet" href="../static/css/goci-ui.css" th:href="@{../../css/goci-ui.css}"/>
    <link rel="stylesheet" href="../static/css/icons/flaticon.css" th:href="@{../../css/icons/flaticon.css}"/>
    <link rel="stylesheet"
          href="../static/css/goci-color-palette-1.css"
          th:href="@{../../css/goci-color-palette-1.css}"/>


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<!--Include header-->
<div th:include="fragments/header :: navbar"></div>

<!-- Main jumbotron for a primary marketing message or call to action -->
<div class="jumbotron background-color-primary-accent" style="margin: 0%; padding-bottom: 30px;">
    <div class="container clearfix">
        <div class="col-lg-7 col-md-7 col-sm-7 col-xs-7">
            <h2 style="margin:0px">
                <img alt="externalLink"
                     style="width: 1em; height: auto;"
                     src="../static/icons/dna13.png"
                     th:src="@{/icons/dna13.png}"/><span style="padding-left:10px">Trait</span><span th:text="${rsId}"
                                                                                                     style="padding-left:15px"></span>
            </h2>
        </div>
        <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 col-lg-offset-1 col-md-offset-1 col-sm-offset-1 col-xs-offset-1">
            <!-- search box goes here -->
            <div class="input-group" style="width: 250px; float: right;">
                <input type="text" class="form-control" placeholder="Search the catalog" id="search-box"/>
                <span class="input-group-btn">
                        <button class="btn btn-default" type="button" id="search-button">
                            <span class="glyphicon glyphicon-search"></span>
                        </button>
                    </span>
            </div>
        </div>
    </div>
</div>

<!--init search parameter-->
<div style="display: none">
    <ul th:object="${result}" id="variables">
        <li id="query" th:text="*{query}">User query</li>
        <li id="facet" th:text="*{facet}">Facet</li>
        <li id="filter" th:text="*{filter}">Disease trait</li>
        <li id="included" th:text="*{included}">Included</li>
    </ul>
</div>


<div class="container-fluid" style="padding-top: 30px">
    <!--search meta data-->
    <ol class="breadcrumb background-color-complementary-accent">
        <li><a href="index.html" th:href="@{/home}">GWAS</a></li>
        <li><a href="#">Traits</a></li>
        <li class="active" th:text="${result.query}"></li>
    </ol>

    <div class="container-fluid" id="lower_container">

        <!--debug information-->
        <div class="row" style="margin-top:10px">
            <div class="panel panel-default">
                <div class="panel-heading background-color-primary-accent">
                    <h3 class="panel-title">debug information</h3>
                </div>
                <div class="col-lg-12">
                    <button id="addEfoButton0" class="addEfoButton" th:value="${result.query}">reset</button>
                    <button id="addEfoButton1"
                            class="addEfoButton"
                            value="EFO_0004211">EFO_0004211 Hypertriglyceridemia</button>
                    <button id="addEfoButton2"
                            class="addEfoButton"
                            value="EFO_0001060">celiac disease EFO_0001060</button>
                    <button id="addEfoButton3" class="addEfoButton" value="EFO_0000400,EFO_0004211,EFO_0001060">EFO_0000400 OR EFO_0004211 OR EFO_0001060</button>
                </div>

                <div class="col-lg-12">
                    <div id="debug">debug information</div>
                </div>
                <input type="checkbox" id="query-include-descendants"/>include descendants
                <button id="btn-query-include-descendants"
                        type="button"
                        class="btn btn-default">replot with descendants
                            </button>

                <button class="btn btn-large btn-primary" data-toggle="confirmation"
                        data-btn-ok-label="Continue" data-btn-ok-icon="glyphicon glyphicon-share-alt"
                        data-btn-ok-class="btn-success"
                        data-btn-cancel-label="Stoooop!" data-btn-cancel-icon="glyphicon glyphicon-ban-circle"
                        data-btn-cancel-class="btn-danger"
                        data-title="Is it ok?" data-content="This might be dangerous">
                  Confirmation
                </button>

            </div>
            <div id="mynetwork"></div>
        </div>

        <!-- Summary panel -->
        <div class="row" style="margin-top:10px">
            <div id="summary-info" class="panel panel-default" style="padding-left:0px">
                <div class="panel-heading background-color-primary-accent">
                    <h3 class="panel-title">Trait information</h3>
                </div>
                <div class="clearfix">
                    <div class="panel-body col-lg-5 col-md-5 col-sm-5 col-xs-5">
                        <!--label-->
                        <div class="clearfix">
                            <div class="col-lg-4 col-md-5 col-sm-5 col-xs-5"
                                 style="font-weight: bold; margin-bottom: 1em;padding-left:0px">Label
                            </div>
                            <div class="col-lg-8 col-md-7 col-sm-7 col-xs-7" id="efotrait-label">-</div>
                        </div>
                        <!--id-->
                        <div class="clearfix">
                            <div class="col-lg-4 col-md-5 col-sm-5 col-xs-5"
                                 style="font-weight: bold; margin-bottom: 1em;padding-left:0px">Trait EFO id
                            </div>
                            <div class="col-lg-8 col-md-7 col-sm-7 col-xs-7" id="efotrait-id">-</div>
                        </div>
                        <!--label-->
                        <div class="clearfix">
                            <div class="col-lg-4 col-md-5 col-sm-5 col-xs-5"
                                 style="font-weight: bold; margin-bottom: 1em;padding-left:0px">Description
                            </div>
                            <div class="col-lg-8 col-md-7 col-sm-7 col-xs-7" id="efotrait-description">-</div>
                        </div>
                        <!--synonym-->
                        <div class="clearfix">
                            <div class="col-lg-4 col-md-5 col-sm-5 col-xs-5"
                                 style="font-weight: bold; margin-bottom: 1em;padding-left:0px">Synonym(s)
                            </div>
                            <div class="col-lg-8 col-md-7 col-sm-7 col-xs-7" id="efotrait-synonym">-</div>
                        </div>
                    </div>

                </div>
                <div id="efotrait-summary">
                    <span class="glyphicon glyphicon-info-sign" style="padding-right:2px"></span>
                    <span id="efotrait-summary-content"></span>
                </div>
            </div>
        </div>

        <!--Expendsion panel-->
        <div class="row" style="margin-top:20px">
            <div id="expension_panel" class="panel panel-default">
                <div class="panel-heading background-color-primary-accent">
                    <h3 class="panel-title">
                        <span class="locus_label">Expend your search</span>
                    </h3>
                    <span class="pull-right">
                        <span class="clickable panel-collapsed"
                              style="margin-left:25px"
                              onclick="toggleSidebar('#expension_panel span.clickable')">
                            <span class="glyphicon glyphicon-chevron-down"></span>
                        </span>
                    </span>
                </div>

                <div class="panel-body" style="display:initial">
                    <div class="col-xs-12 jumbotron background-color-primary-accent">
                        <div class="col-xs-6">Current terms:
                            <div id="selected-efos"></div>
                            <div id="selected-efos_text"></div>
                        </div>
                        <div style="display:none" id="efo-info"></div>
                        <div class="col-xs-6">
                            <input type="text" id="sharable_link" class="col-xs-6"></input>
                            <div class="col-xs-1">
                            <button id="sharable_link_btn"
                                    type="button"
                                    class="btn btn-default"
                                    data-clipboard-target="#sharable_link">
                              <span class="glyphicon glyphicon-floppy-disk"
                                    aria-hidden="true"
                                    title="copy to clipboard"></span>
                            </button>
                            </div>
                        </div>
                    </div>


                    <div class="col-xs-4">
                        <!--ols tree-->
                        <h4>Related in EFO hierarchy:</h4>
                        <div id="term-tree"
                             style="height:300px; width:500px; border:1px solid black;overflow: auto;"></div>
                    </div>
                    <div class="col-xs-4">
                        <div id="expension">
                            <h4>Additional related terms eg. measurements and biomarkers:</h4>
                        </div>
                    </div>
                    <div class="col-xs-4">
                        <!--auto suggest-->
                        <h4>Search for additional terms:</h4>
                        <div class="left">
                            <label>
                                <input style="font-weight: normal"
                                       size="35"
                                       type="text"
                                       name="q"
                                       data-olswidget="select"
                                       data-olsontology="efo"
                                       data-selectpath="http://www.ebi.ac.uk/ols/"
                                       olstype=""
                                       id="local-searchbox"
                                       placeholder="Enter the term you are looking for"
                                       class="ac_input">
                                </input>
                            </label>
                        </div>
                    </div>

                    <div class="col-xs-12">
                        <div id="ontology_vis"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- List the available tables -->
    <div class="row" style="margin-top:0px">
        <div id="table-list" class="panel clearfix" style="padding-left:0px;box-shadow:none">
            <span style="margin-right:10px;font-weight:bold">Available data:</span>
            <button type="button"
                    class="btn btn-default"
                    style="margin-right:10px;font-weight:bold"
                    onclick="toggle_and_scroll('#locus_panel')">
                    <span class="locus_label">Manhattan plot</span><span class="glyphicon glyphicon-stats"
                                                                         style="color:#398A96;margin-left:10px"></span>
                </button>
            <button type="button"
                    class="btn btn-default"
                    style="margin-right:10px;font-weight:bold"
                    onclick="toggle_and_scroll('#association_panel')">
                    <span class="association_label">Associations</span><span class="association_count badge"
                                                                             style="background-color: #398A96;margin-left:10px"></span>
                </button>
            <button type="button"
                    class="btn btn-default"
                    style="margin-right:10px;font-weight:bold"
                    onclick="toggle_and_scroll('#study_panel')">
                    <span class="study_label">Studies</span><span class="study_count badge"
                                                                  style="background-color: #398A96;margin-left:10px"></span>
                </button>
            <!--<button type="button" class="btn btn-default" style="margin-right:10px;font-weight:bold" onclick="toggle_and_scroll('#diseasetrait_panel')">-->
            <!--<span class="diseasetrait_label">Traits</span><span class="diseasetrait_count badge" style="background-color: #398A96;margin-left:10px"></span>-->
            <!--</button>-->
        </div>
    </div>

    <!-- locus plot -->
    <div class="row" style="margin-top:20px">
        <div id="locus_panel" class="panel panel-default">
            <div class="panel-heading background-color-primary-accent">
                <h3 class="panel-title">
                    <span class="locus_label">Manhattan plot (plot of has catalog association for selected trait)</span>
                    <span class="glyphicon glyphicon-stats" style="color:#398A96;margin-left:10px"></span>
                </h3>
                <span class="pull-right">
                        <span class="clickable panel-collapsed"
                              style="margin-left:25px"
                              onclick="toggleSidebar('#locus_panel span.clickable')">
                            <span class="glyphicon glyphicon-chevron-down"></span>
                        </span>
                    </span>
            </div>
            <!--<div class="panel-body" style="display:none">-->
            <div class="panel-body" style="display:initial">
                <!-- locus plot -->

                <div id="plot_load" class="col-md-offset-4" style="display: none">
                    <button class="btn btn-lg">
                        <span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span>
                    </button>
                </div>
                <div id="plot" style=" width: 600px; height: 400px;"></div>
            </div>
        </div>
    </div>


    <!-- Associations table -->
    <div class="row" style="margin-top:20px">
        <div id="association_panel" class="panel panel-default">
            <div class="panel-heading background-color-primary-accent">
                <h3 class="panel-title">
                    <span class="association_label">Associations</span><span class="association_count badge"
                                                                             style="background-color: #398A96;margin-left:10px"></span>
                </h3>
                <span class="pull-right">
                        <button type="button" class="btn btn-default btn-xs" id="download_data">
                            <span class="glyphicon glyphicon-download-alt" style="padding-right:2px"></span>
                            <span>Download association data</span>
                        </button>
                        <span class="clickable panel-collapsed"
                              style="margin-left:25px"
                              onclick="toggleSidebar('#association_panel span.clickable')">
                            <span class="glyphicon glyphicon-chevron-down"></span>
                        </span>
                    </span>
            </div>

            <div class="panel-body" style="display:none">

                <table id="association-table" class="table table-striped">
                    <thead id="association-table-header">
                    <tr>
                        <th style="width: 10%" id="strongestAllele">Risk allele
                            <span class="glyphicon glyphicon-question-sign context-help"
                                  data-toggle="tooltip"
                                  data-original-title="Variant most strongly associated with trait + risk/effect allele. This may also be haplotype or variant x variant interaction."></span>
                                                                    <!--<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>-->
                        </th>
                        <th style="width: 8%" id="riskFrequency">RAF
                            <span class="glyphicon glyphicon-question-sign context-help"
                                  data-toggle="tooltip"
                                  data-original-title="Risk/effect allele frequency in controls"></span>
                            <span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>
                        </th>
                        <th style="width: 12%" id="pValue">p-value
                            <span class="glyphicon glyphicon-question-sign context-help"
                                  data-toggle="tooltip"
                                  data-original-title="p-value for most strongly associated variant, along with any information describing context of p-value"></span>
                            <span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>
                        </th>
                        <th style="width: 6%" id="orPerCopyNum">OR
                            <span class="glyphicon glyphicon-question-sign context-help"
                                  data-toggle="tooltip"
                                  data-original-title="Odds ratio associated with variant"></span>
                            <span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>
                        </th>
                        <th style="width: 14%" id="orType">Beta
                            <span class="glyphicon glyphicon-question-sign context-help"
                                  data-toggle="tooltip"
                                  data-original-title="Beta-coefficient and unit increase/decrease associated with variant"></span>
                            <span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>
                        </th>
                        <th style="width: 6%">CI
                            <span class="glyphicon glyphicon-question-sign context-help"
                                  data-toggle="tooltip"
                                  data-original-title="95% confidence interval for OR or beta"></span>
                        </th>

                        <th style="width: 8%">Reported gene(s)
                            <span class="glyphicon glyphicon-question-sign context-help"
                                  data-toggle="tooltip"
                                  data-original-title="Gene(s) reported by author"></span>
                        </th>

                        <th style="width: 13%" id="traitName_s-alt">Reported trait
                            <span class="glyphicon glyphicon-question-sign"
                                  data-toggle="tooltip"
                                  data-original-title="Description of disease/trait analysed in the study"></span>
                            <span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>
                        </th>
                        <th style="width: 13%" id="traitName-alt">Mapped trait
                            <span class="glyphicon glyphicon-question-sign"
                                  data-toggle="tooltip"
                                  data-original-title="Description of disease/trait mapped to the study"></span>
                            <span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>
                        </th>
                        <th style="width: 15%" id="author_s-alt" colspan="2">Study
                            <span class="glyphicon glyphicon-question-sign context-help"
                                  data-toggle="tooltip"
                                  data-original-title="First author and year of publication, along with link to publication in Europe PubMed Central."></span>
                            <span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>
                        </th>
                    </tr>
                    </thead>
                    <tbody id="association-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Studies table -->
    <div class="row" style="margin-top:20px">
        <div id="study_panel" class="panel panel-default">
            <div class="panel-heading background-color-primary-accent">
                <h3 class="panel-title">
                    <span class="study_label">Studies</span><span class="study_count badge"
                                                                  style="background-color: #398A96;margin-left:10px"></span>
                </h3>

                <span class="pull-right clickable panel-collapsed"
                      onclick="toggleSidebar('#study_panel span.clickable')">
                        <span class="glyphicon glyphicon-chevron-down"></span>
                    </span>
            </div>

            <div class="panel-body" style="display:none">
                <table id="study-table" class="table table-striped">
                    <thead id="study-table-header">
                    <tr>
                        <th style="width: 12%" id="author_s">Author
                            <span class="glyphicon glyphicon-question-sign context-help"
                                  data-toggle="tooltip"
                                  data-original-title="First author, along with link to publication in Europe PubMed Central."></span>
                            <span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>
                        </th>
                        <th style="width: 10%" id="publicationDate">Date
                            <span class="glyphicon glyphicon-question-sign context-help"
                                  data-toggle="tooltip"
                                  data-original-title="Publication date (YYYY-MM-DD)"></span>
                            <span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>
                        </th>
                        <th style="width: 12%" id="publication">Journal
                            <span class="glyphicon glyphicon-question-sign context-help"
                                  data-toggle="tooltip"
                                  data-original-title="Abbreviated journal name"></span>
                            <span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>
                        </th>
                        <th style="width: 30%" id="title">Title
                            <span class="glyphicon glyphicon-question-sign context-help"
                                  data-toggle="tooltip"
                                  data-original-title="Title of paper"></span>
                                                          <!--<span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>-->
                        </th>
                        <th style="width: 12%" id="sample_i">Initial sample description
                            <span class="glyphicon glyphicon-question-sign context-help"
                                  data-toggle="tooltip"
                                  data-original-title="Description of the initial sample analysed in the study"></span>
                            <span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>
                        </th>
                        <th style="width: 12%" id="sample_r">Replication sample description
                            <span class="glyphicon glyphicon-question-sign context-help"
                                  data-toggle="tooltip"
                                  data-original-title="Description of the replication sample analysed in the study"></span>
                            <span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>
                        </th>
                        <th style="width: 12%" id="ancestral_gp">Ancestral groups
                            <span class="glyphicon glyphicon-question-sign context-help"
                                  data-toggle="tooltip"
                                  data-original-title="List of the ancestral groups analysed in the study"></span>
                            <span class="glyphicon glyphicon-sort clickable sorting unsorted"> </span>
                        </th>
                    </tr>
                    </thead>
                    <tbody id="study-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>


</div>

<!--Include footer-->
<div th:include="fragments/footer :: page_footer"></div>


<!-- Bootstrap core JavaScript
    ================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>-->
<script src="../static/tmp/jquery.min.js" th:src="@{../../tmp/jquery.min.js}"></script>
<!--<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>-->
<script src="../static/tmp/jquery-ui.min.js" th:src="@{../../tmp/jquery-ui.min.js}"></script>


<script src="../static/js/bootstrap.min.js" th:src="@{../../js/bootstrap.min.js}"></script>
<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="../static/js/ie10-viewport-bug-workaround.js"
        th:src="@{../../js/ie10-viewport-bug-workaround.js}"></script>
<script>
    $(document).ready(function() {
        $('[data-toggle="tooltip"]').tooltip();
    });
</script>

<!-- GOCI JavaScript
================================================== -->
<script src="../static/js/goci-ui.js" th:src="@{../../js/goci-ui.js}"></script>
<script src="../static/js/efotraitresult.js" th:src="@{../../js/efotraitresult.js}"></script>

<!-- Necessary includes for LocusZoom.js -->
<!--<script src="https://d3js.org/d3.v4.min.js"></script>-->
<script src="../static/js/plugins/locuszoom.vendor.min.js"
        th:src="@{../../js/plugins/locuszoom.vendor.min.js}"></script>
<script src="../static/js/plugins/locuszoom.app.js" th:src="@{../../js/plugins/locuszoom.app.js}"></script>
<link rel="stylesheet" href="../static/css/locuszoom.css" th:href="@{../../css/locuszoom.css}"/>

<!--visjs-->
<!--<script src="../static/js/plugins/vis.min.js" th:src="@{../../js/plugins/vis.min.js}"></script>-->
<!--<link href="../static/css/vis.min.css" rel="stylesheet" type="text/css" th:href="@{../../css/vis.min.css}"/>-->

<!--clipboardjs-->
<script src="../static/js/plugins/clipboard.min.js" th:src="@{../../js/plugins/clipboard.min.js}"></script>


<!--script for OLS-->
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>-->
<script src="../static/tmp/jstree.min.js" th:src="@{../../tmp/jstree.min.js}"></script>

<script src="../static/js/plugins/ols-treeview.js" th:src="@{../../js/plugins/ols-treeview.js}"></script>
<!--<script src="../static/js/plugins/ols-treeview.min.js" th:src="@{../../js/plugins/ols-treeview.min.js}"></script>-->
<link rel="stylesheet"
      href="../static/css/proton/style.min.css"
      th:href="@{../../css/proton/style.min.css}"
      media="screen"/>

<!--ols auto suggest-->
<link rel="stylesheet" href="../static/css/ols_auto_complete/ols.css" th:href="@{../../css/ols_auto_complete/ols.css}"/>
<link rel="stylesheet"
      href="../static/css/ols_auto_complete/ols-colors.css"
      th:href="@{../../css/ols_auto_complete/ols-colors.css}"/>
<link rel="stylesheet"
      href="../static/css/ols_auto_complete/typeaheadjs.css"
      th:href="@{../../css/ols_auto_complete/typeaheadjs.css}"/>

<!--ols_graph-->
<link rel="stylesheet"
      href="../static/css/ols_graph/awesomplete.css"
      th:href="@{../../css/ols_graph/awesomplete.css}"
      type="text/css"/>
<link rel="stylesheet"
      href=".../static/css/ols_graph/OLS-graphview.css"
      th:href="@{../../css/ols_graph/OLS-graphview.css}"
      type="text/css"
      media="screen"/>
<link rel="stylesheet"
      href="../static/css/ols_graph/vis.min.css"
      th:href="@{../../css/ols_graph/vis.min.css}"
      type="text/css"/>
<script src="../static/js/plugins/ols-graphview.js" th:src="@{../../js/plugins/ols-graphview.js}"></script>


<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>-->
<script src="../static/tmp/handlebars.min.js" th:src="@{../../tmp/handlebars.min.js}"></script>

<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/corejs-typeahead/0.11.1/typeahead.bundle.min.js"></script>-->
<script src="../static/tmp/typeahead.bundle.min.js" th:src="@{../../tmp/typeahead.bundle.min.js}"></script>

<script src="../static/js/plugins/ols-autocomplete.js" th:src="@{../../js/plugins/ols-autocomplete.js}"></script>

<!--<script src="../static/js/bootstrap-confirmation.min.js" th:src="@{../../js/bootstrap-confirmation.min.js}"></script>-->


<div id="loadingResults" class="col-md-offset-4" style="display: none">
    <button class="btn btn-lg">
        <span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"
              style="margin-right: 1em;"></span>Loading...
    </button>
</div>
<script>
    $('#loadingResults').show();
</script>

<!--<script src="../static/js/efotrait-locuszoom.js" th:src="@{../../js/efotrait-locuszoom.js}"></script>-->





<!--gwas Locus plot-->
<script src="../static/js/efotrait-locuszoom.js" th:src="@{../../js/efotrait-locuszoom.js}"></script>
<script src="../static/js/efotrait-util.js" th:src="@{../../js/efotrait-util.js}"></script>



<!--local data-->
<script th:inline="javascript">
    /*<![CDATA[*/

    //show/hide spinner
    toggleSpinner = function(tagID) {
        var spinnerID = tagID + '_load';
        $(spinnerID).toggle();
        $(tagID).toggle();

    }

    $('.addEfoButton').click(function() {
        var elements = {};
        $(this).attr('value').split(',').forEach(function(index, value) {
            elements[index] = index;
        });
        //xintodo first load
        addEFO(elements, true);
//        getEfoTraitData($(this).attr('value'));
//        console.log('clicked' + $(this).attr('value'));
    });

    $('#btn-query-include-descendants').click(function() {
        //replot with all children, from the currently selected efos
        addEFO({}, false, true);
//        getEfoTraitData($(this).attr('value'));
//        console.log('clicked' + $(this).attr('value'));
    });


    $(document).ready(function() {
        if (window.location.pathname.indexOf("beta") != -1) {
            $('#beta-icon').show();
        }
        var searchTerm = $('#query').text();
        var included = $('#included').text();
        if (included != '') {
            searchTerm = searchTerm + ',' + included;
        }
        console.log("Loading search module!");
        if (searchTerm != '') {
            console.log("Start search for the efotrait " + searchTerm);
            var elements = {};
            searchTerm.split(',').forEach(function(term) {
                                              elements[term] = term;
                                          }
            )
            //xintodo first load
            addEFO(elements, true);
        }
    });



    //make solr query
    function getEfoTraitData(mainEFO, additionalEFO, descendants, initLoad) {
        // initLoad will be pass to processEfotraitData, controlling whether to upload the triat information(init load)
        // or just reload the tables(adding another efo term)
        if (initLoad === undefined) {
            initLoad = false;
        }

        var searchQuery = mainEFO;

        if (additionalEFO.length > 0) {
            var additionalEFO_filtered = filterAvailableEFOs(additionalEFO);
            if (additionalEFO_filtered.length > 0)
                searchQuery = searchQuery + ',' + additionalEFO_filtered.join(',');
        }

        if (descendants.length > 0) {
            var descendants_filtered = filterAvailableEFOs(descendants);
            if (descendants_filtered.length > 0)
                searchQuery = searchQuery + ',' + descendants_filtered.join(',');
        }


        console.log("Solr research request received for " + searchQuery);
        setState(SearchState.LOADING);
        //xintodo change to post?
        $.getJSON('/gwas/api/search/efotrait',
                  {
                      'q': searchQuery,
                      'max': 9999,
                      'group.limit': 9999,
                      'group.field': 'resourcename',
                      'facet.field': 'resourcename',
                      'hl.fl': 'shortForm,efoLink',
                      'hl.snippets': 100
                  })
                .done(function(data) {
//                    console.log(data);
                    //xintodo consider if you want to do it this way, or just change the seach and update the tables
                    //saveData(data.responseHeader.params.q, data);
                    //we only process data here if it is the init load of the page, since we need to add new data to the page dynamically
                    processEfotraitData(data, mainEFO, initLoad);
                });
        console.log("Solr research done for " + searchQuery);

    }

    //get data for the summary panel
    function getEfoTraitInfo(data, efotraitId) {
        findEFOInfo(efotraitId).then(function(response) {
            var efotrait_link = response.iri;
            var efotrait_id = efotraitId;
            var synonym = response.synonyms;
            var efotrait_label = response.label;
            addDataToTag(global_efo_info_tag_id, response, 'mainEFOInfo');
            $("#efotrait-description").html(response.description);
            $("#efotrait-id").html(setExternalLink(efotrait_link, efotrait_id));
            $("#efotrait-label").html(efotrait_label);
            if (synonym) {
                if (synonym.length > list_min) {
                    $("#efotrait-synonym").html(longContentList("gwas_efotrait_synonym_div",
                                                                synonym,
                                                                'synonyms'));
                }
                else {
                    $("#efotrait-synonym").html(synonym.join(", "));
                }
            }
        }).catch(function(err) {
                     //if query to ols fail, use our solr result
                     var data_sample = data[0];
                     var efotrait_id = efotraitId;
                     var efotrait_link = data_sample.traitUri;
                     var synonym = data_sample.synonym;
                     var efotrait_label = data_sample.label;

                     $("#efotrait-id").html(setExternalLink(efotrait_link, efotrait_id));
                     $("#efotrait-label").html(efotrait_label + 'aaaaa');
                     if (synonym) {
                         if (synonym.length > list_min) {
                             $("#efotrait-synonym").html(longContentList("gwas_efotrait_synonym_div",
                                                                         synonym,
                                                                         'synonyms'));
                         }
                         else {
                             $("#efotrait-synonym").html(synonym.join(", "));
                         }
                     }
                 }
        )
    }


    //Parse the Solr results and display the data on the HTML page
    function processEfotraitData(data, efotraitId, initLoad) {
        // Check if Solr returns some results
        if (data.grouped.resourcename.matches == 0) {
            $('#lower_container').html("<h2>The efotrait <em>" + efotraitId +
                                       "</em> cannot be found in the GWAS Catalog database</h2>");
        }
        else {
            //split the solr search by groups
            var data_efo, data_study, data_association, data_diseasetrait;
            var data_facet = data.facet_counts.facet_fields.resourcename;
            var data_highlighting = data.highlighting;

            $.each(data.grouped.resourcename.groups, function(index, group) {
                switch (group.groupValue) {
                    case "efotrait":
                        data_efo = group.doclist;
                        break;
                    case "study":
                        data_study = group.doclist;
                        break;
                    case "association":
                        data_association = group.doclist;
                        break;
                        //not sure we need this!
                    case "diseasetrait":
                        data_diseasetrait = group.doclist;
                        break;
                    default:
                }
            });

            findHightlightedEFOsforAssociation = function(association_id) {
                var terms = data.highlighting[association_id].shortForm;
                terms.forEach(function(d, i) {
                    //xintodo only efo?
                    terms[i] = d.match(/<b>(\w*_\d*)<\/b>/)[1];
                })
                return terms;
            }

            findMostSignificantTraitForAssociation = function(traits, association) {
                return traits[0];
            }

            //function to pick a color for a give efo term
            findColourForEFO = function(efo) {
                //xintodo query api for color, may use batch query for efo color
                var url = global_color_url + efo;
                return promiseGet(url).then(JSON.parse).then(function(response) {
                    return response;
                })
            }

            //query for distinct efo terms. This will reduce the query number so work faster
            var allEFO = {}
            var allColorLoaded = []
            data_association.docs.forEach(function(d, i) {
                var traits = findHightlightedEFOsforAssociation(d.id);
                if (traits.length > 1) {
                    d.preferedEFO = findMostSignificantTraitForAssociation(traits, d.id);
                }
                else {
                    d.preferedEFO = traits[0];
                    d.preferedColor = ''

                }
                allEFO[d.preferedEFO] = '';
            })

//            {
//                uri: "http://www.ebi.ac.uk/efo/EFO_0000400",
//                        trait: "diabetes mellitus",
//                    parentUri: "http://www.ebi.ac.uk/efo/EFO_0000589",
//                    parent: "metabolic disease",
//                    colour: "#FDB462"
//            }
            Object.keys(allEFO).forEach(function(efo) {
                allColorLoaded.push(findColourForEFO(efo).then(function(response) {
                    allEFO[efo] = response;
                    return response;
                }));
            })

            //When all colour are received, replot
            Promise.all(allColorLoaded).then(function() {
                                                 console.log('Finish loading color from ' + global_color_url);
                                                 console.log(allEFO);
                                                 data_association.docs.forEach(function(d, i) {
                                                     d.preferedColor = allEFO[d.preferedEFO].colour;
                                                     d.preferedParentUri = allEFO[d.preferedEFO].parentUri;
                                                     d.preferedParentLabel = allEFO[d.preferedEFO].parent;
                                                     d.category = allEFO[d.preferedEFO].parent;
                                                 })
                                                 if (initLoad) {
                                                     getEfoTraitInfo(data_efo.docs, efotraitId);
                                                     getSummary(data_study);
                                                 }
                                                 getEfotraitAssociations(data_association.docs);
                                                 getEfotraitStudies(data_study.docs);
                                                 readlodLocusZoom('#plot', data_association);
                                             }
            ).catch(function(err) {
                console.error('Error loading colour from ' + global_color_url + ' with ' + err);
                //xintodo create a default colour to plot, if the colour query fail
                if (initLoad) {
                    getEfoTraitInfo(data_efo.docs, efotraitId);
                    getSummary(data_study);
                }
                getEfotraitAssociations(data_association.docs);
                getEfotraitStudies(data_study.docs);
                readlodLocusZoom('#plot', data_association);
            });
        }
    }


    findEFOInfoLocal = function(efoid) {
        var data = getDataFromTag(global_efo_info_tag_id, 'efoInfo')
        if(data==undefined)
            return undefined;
        return data[efoid]
    }

    findOntologyInfoLocal = function(ontologyId) {
        var data = getDataFromTag(global_efo_info_tag_id, 'ontologyInfo')
        if(data==undefined)
            return undefined;
        return data[ontologyId]
    }

    findOntologyInfo = function(ontologyId){
        ontologyId = ontologyId.toLowerCase();
        var localefoinfo = findOntologyInfoLocal(ontologyId)
        if (localefoinfo) {
            return new Promise(function(resolve, reject) {
                resolve(localefoinfo);
            })
        }

        return promiseGet('http://www.ebi.ac.uk/ols/api/ontologies',{'size':99999}).then(JSON.parse).then(function(response){
            var ontologyInfo = {};
            response._embedded.ontologies.forEach(function(d){
                ontologyInfo[d.ontologyId] = d;
            })
            addDataToTag(global_efo_info_tag_id,ontologyInfo,'ontologyInfo')
            return ontologyInfo[ontologyId];
        }).catch(function(err){
            console.error('Error when querying ontology info. ' + err);
            return err;
        })
    }

    findIriByShortForm = function(shortForm){
        var prefix = shortForm.split('_')[0];
        var id = shortForm.split('_')[1];
        var p = findOntologyIdByPrefix(prefix)

        return p.then(function(ontology){
            return findOntologyInfo(ontology).then(function(o){
                return {'ontology':ontology,'iri' : o.config.baseUris[0] + id};
            })
        }).catch(function(err){
            console.log('Error finding iri for term ' + shortForm + '. ' + err);
        })
    }

    fetchOntologyInfo=function(){
        return promiseGet('http://www.ebi.ac.uk/ols/api/ontologies',{'size':99999}).then(JSON.parse).then(function(response){
            var ontologyInfo = {};
            var prefix2ontid = {}
            response._embedded.ontologies.forEach(function(d){
                ontologyInfo[d.ontologyId] = d;
                prefix2ontid[d.config.baseUris[0].split('/').slice(-1)[0].split('_')[0]] = d.ontologyId;
            })
            addDataToTag(global_efo_info_tag_id,ontologyInfo,'ontologyInfo')
            addDataToTag(global_efo_info_tag_id,prefix2ontid,'prefix2ontid')
            return response;
        }).catch(function(err){
            console.error('Error when querying ontology info. ' + err);
            return err;
        })
    }

    findOntologyIdByPrefix = function(prefix) {
        if(getDataFromTag(global_efo_info_tag_id, 'ontologyInfo')==undefined || getDataFromTag(global_efo_info_tag_id, 'prefix2ontid') == undefined){
            return fetchOntologyInfo().then(function(){
                return getDataFromTag(global_efo_info_tag_id, 'prefix2ontid')[prefix]
            });
        }else{
            return new Promise(function(resolve, reject) {
                resolve(getDataFromTag(global_efo_info_tag_id, 'prefix2ontid')[prefix]);
            })
        }
    }


    findEFOInfo = function(shortForm) {
        //EFO does not follow the same naming convension
        //need to due with terms such as 'CHEBI_17234'
        console.debug(shortForm);
        return findIriByShortForm(shortForm).then(function(response) {
            var ont = response.ontology;
            var iri = response.iri;

            var localefoinfo = findEFOInfoLocal(shortForm)
            if (localefoinfo) {
                return new Promise(function(resolve, reject) {
                    resolve(localefoinfo);
                })
            }

            var url = global_ols_api + 'ontologies/' + ont + '/terms/' + encodeURIComponent(encodeURIComponent(iri));
            return promiseGet(url).then(JSON.parse).then(function(response) {
                var tmp = {};
                tmp[shortForm] = response;
                addDataToTag(global_efo_info_tag_id, tmp, 'efoInfo');
                return response;
            }).catch(function(err){
                console.debug('error when loading efo info for ' + shortForm + '. ' + err);
                return err;
            })

        });
    }

    findAllHierarchicalDescendantsLocal = function(efoid) {
        var decendants =getDataFromTag(global_efo_info_tag_id,'efoDecendants');
        if (decendants == undefined)
            return decendants
        return decendants[efoid];
    }

    findAllHierarchicalDescendants = function(efoid) {
        return findEFOInfo(efoid).then(function(response) {
            console.log('looking for descendants for ' + efoid);
            console.log(response);
            if (response.has_children) {
                var localDescentandInfo = findAllHierarchicalDescendantsLocal(efoid)
                if (localDescentandInfo) {
                    return new Promise(function(resolve, reject) {
                        resolve(localDescentandInfo);
                    })
                }
                //xintodo size >=1000 is set to 1000 by ols, ask?
                return promiseGet(response._links.hierarchicalDescendants.href + '?size=' +
                                  global_ols_api_all_descendant_limit).then(JSON.parse).then(function(response) {
                    console.log('all descendants: ');
                    console.log(response);
                    var terms = {};
                    response._embedded.terms.forEach(function(d, i) {
                        terms[d.short_form] = d;
                    })
                    var tmp = {}
                    tmp[efoid] = Object.keys(terms);
                    addDataToTag(global_efo_info_tag_id, terms, 'efoInfo');
                    addDataToTag(global_efo_info_tag_id, tmp, 'efoDecendants')
                    return response._embedded.terms;
                })
            }
            else {
                console.log('no descendant.');
                return new Promise(function(resolve, reject) {
                    resolve(JSON.parse("[]"));
                }).then(function() {
                    tmp = {}
                    tmp[efoid] = []
                    addDataToTag(global_efo_info_tag_id, tmp, 'efoDecendants')
                })
            }
        })
    }

    addDataToTag = function(tagID, hash, key, overwriteWarning) {
        var old = $(tagID).data(key) || {};
        overwriteWarning = overwriteWarning || false;
        if (overwriteWarning) {
            var result = Object.keys(old).filter(function(n) {
                return Object.keys(hash).indexOf(n) > -1;
            });
            if (result.length > 0) {
                result.forEach(function(d) {
                    console.log(d + 'will be overwritten.')
                })
            }
        }
        result = $.extend({}, old, hash)
        if (key) {
            $(tagID).data(key, result)
        }
        else {
            $(tagID).data(result)
        }

        return result;
    }

    getDataFromTag = function(tagID, key) {
        key = key || ''
        var data = $(tagID).data();
        if (key == '')
            return data
        if (Object.keys(data).valueOf(key) == -1){
            console.warn('The requested data with key ' + key + ' to ' + tagID + ' does not exist!');
            return undefined;
        }
        return data[key]
    }

    //*****new



    //return a data promise containing all available efos. lazy load.
    getAvailableEFOs=function(){
        var dataPromise = getDataFromTag(global_efo_info_tag_id,'availableEFOs');
        if(dataPromise == undefined){
            //lazy load
            console.log('Loading all available EFOs in Gwas Catalog...')
            dataPromise =  promiseGet('/gwas/api/search/efotrait', {
                'q': '*:*',
                'max': 9999,
                'fq': 'resourcename:efotrait',
                'group.limit': 9999
            }).then(JSON.parse).then(function(data) {
                $.each(data.grouped.resourcename.groups, function(index, group) {
                    switch (group.groupValue) {
                        case "efotrait":
                            available_efos_docs = group.doclist.docs;
                            break;
                        default:
                    }
                });
                var tmp = {};
                available_efos_docs.forEach(function(doc) {
                    if (doc.shortForm) {
                        tmp[doc.shortForm[0]] = doc;
                    }
                });

                return tmp;
            }).catch(function(err){
                console.error('Error when loading all available EFOs! ' + err);
            })

            //add to tag
            $(global_efo_info_tag_id).data('availableEFOs',dataPromise);

        }else{
            console.debug('Loading all available EFOs from cache.')
        }
        return dataPromise;
    }

    //load ontology info
    getOntologyInfo=function() {
        var dataPromise = getDataFromTag(global_efo_info_tag_id, 'ontologyInfo');
        if (dataPromise == undefined) {
            //lazy load
            console.log('Loading Ontology Info...')
            dataPromise = promiseGet('http://www.ebi.ac.uk/ols/api/ontologies',
                              {'size': 99999}).then(JSON.parse).then(function(response) {
                var ontologyInfo = {};
                response._embedded.ontologies.forEach(function(d) {
                    ontologyInfo[d.ontologyId] = d;
                })

                return ontologyInfo;
            }).catch(function(err) {
                console.error('Error when loading ontology info! ' + err);
            })

            //add to tag
            $(global_efo_info_tag_id).data('ontologyInfo',dataPromise);
        }else{
            console.debug('Loading Ontology Info from cache.')
        }
        return dataPromise;
    }

    getPrefix2OntologyId=function(){
        var dataPromise = getDataFromTag(global_efo_info_tag_id, 'prefix2ontId');
        if (dataPromise == undefined) {
            //lazy load
            console.log('Loading prefix2ontId...')
            dataPromise = getOntologyInfo().then(function(ontoInfo){
                var prefix2ontid = {}
                Object.keys(ontoInfo).forEach(function(ontId){
                    prefix2ontid[ontoInfo[ontId].config.baseUris[0].split('/').slice(-1)[0].split('_')[0]] = ontId;
                })
                return prefix2ontid;
            }).catch(function(err){
                console.error('Error when loading prefix2ontId! ' + err);
            })
            //add to tag
            $(global_efo_info_tag_id).data('prefix2ontId',dataPromise);
        }else{
            console.debug('Loading prefix2ontId from cache.')
        }
        return dataPromise;
    }

    getOntologyIdByPrefix = function(prefix) {
         return getPrefix2OntologyId().then(function(p2o){
             return p2o[prefix]
         })
    }

    getIriByShortForm = function(shortForm){
        var prefix = shortForm.split('_')[0];
        var id = shortForm.split('_')[1];
        var ont = getOntologyByShortForm(shortForm);

        return ont.then(function(ontName){
            return getOntologyInfo().then(function(ontologies){
                return ontologies[ontName].config.baseUris[0] + id;
            })
        }).catch(function(err){
            console.log('Error finding iri for term ' + shortForm + '. ' + err);
        })
    }

    getOntologyByShortForm = function(shortForm){
        var prefix = shortForm.split('_')[0];
        var id = shortForm.split('_')[1];
        p = getOntologyIdByPrefix(prefix);

        return p.then(function(ontology){
            return ontology;
        }).catch(function(err){
            console.log('Error finding iri for term ' + shortForm + '. ' + err);
        })
    }

    getRelatedTerms = function(efoid){
        queryRelatedTerms = function(efoid){
            console.log('Loading related terms...')
            return searchOLS(efoid,{
                'ontology': 'efo',
                'fieldList': 'iri,ontology_name,ontology_prefix,short_form,description,id,label,is_defining_ontology,obo_id,type,logical_description'
            }).then(function(data){
                var terms = {};
                data.response.docs.forEach(function(d) {
                    d.obo_id = d.obo_id.replace(":", "_")
                    terms[d.obo_id] = d
                })
                var tmp={};
                tmp[efoid] = terms;
                return tmp;
            }).catch(function(err){
                console.error('Error when loading related terms! ' + err);
            })
        }

        var dataPromise = getPromiseFromTag(global_efo_info_tag_id, 'relatedEFOs');

        return dataPromise.then(function(data){
            //query if data not exist
            if($.inArray(efoid,Object.keys(data)) == -1){
                dataPromise = queryRelatedTerms(efoid);
                return dataPromise.then(function(data){
                    //add to tag
                    addPromiseToTag(global_efo_info_tag_id,dataPromise,'relatedEFOs');
                    return data[efoid];
                })
            }else{
                console.debug('Loading related terms from cache.')
                return data[efoid]
            }
        })
    }

    getColourForEFO = function(efoid) {
        queryColour = function(efoid){
            console.log('Loading Colour...')
            return promiseGet(global_color_url + efoid).then(JSON.parse).then(function(response) {
                var tmp = {};
                tmp[efoid] = response;
                return tmp;
            }).catch(function(err) {
                console.error('Error when loading Colour! ' + err);
            })
        }

        var dataPromise = getPromiseFromTag(global_efo_info_tag_id, 'efo2colour');

        return dataPromise.then(function(data) {
            if ($.inArray(efoid, Object.keys(data)) == -1) {
                //efo colour is not currently loaded
                console.log('Loading Colour...')
                dataPromise = queryColour(efoid);
                return dataPromise.then(function(data){
                    //add to tag
                    addPromiseToTag(global_efo_info_tag_id,dataPromise,'efo2colour');
                    return data[efoid];
                })
            }else {
                //efo colour is has been loaded perviously
                console.debug('Loading Colour from cache.')
                return data[efoid]
            }
        })
    }

    getEFOInfo = function(efoid){
        queryEFOInfo = function(efoid){
            var ont = getOntologyByShortForm(efoid);
            var iri = getIriByShortForm(efoid);
            return Promise.all([ont,iri]).then(function(arrayPromise){
                var url = global_ols_api + 'ontologies/' + arrayPromise[0] + '/terms/' + encodeURIComponent(encodeURIComponent(arrayPromise[1]));
                return promiseGet(url).then(JSON.parse).then(function(response) {
                    var tmp = {};
                    tmp[efoid] = response;
                    return tmp;
                }).catch(function(err){
                    console.debug('error when loading efo info for ' + efoid + '. ' + err);
                })
            })

        }

        var dataPromise = getPromiseFromTag(global_efo_info_tag_id, 'efoInfo');
        return dataPromise.then(function(data) {
            if ($.inArray(efoid, Object.keys(data)) == -1) {
                //efo info is not currently loaded
                console.log('Loading efoInfo for ' + efoid)
                dataPromise = queryEFOInfo(efoid);
                return dataPromise.then(function(data){
                    //add to tag
                    addPromiseToTag(global_efo_info_tag_id,dataPromise,'efoInfo');
                    return data[efoid];
                })
            }else {
                //efo colour is has been loaded perviously
                console.debug('Loading efoInfo from cache for ' + efoid);
                return data[efoid]
            }
        })
    }

    getHierarchicalDescendants = function(efoid){
        queryDescendant = function(efoid){
            var efoinfo = getEFOInfo(efoid)
            return efoinfo.then(function(response){
                if (response.has_children) {
                    //xintodo size >=1000 is set to 1000 by ols, ask?
                    return promiseGet(response._links.hierarchicalDescendants.href + '?size=' +
                                      global_ols_api_all_descendant_limit).then(JSON.parse).then(function(response) {
                        var terms = {};
                        response._embedded.terms.forEach(function(d, i) {
                            terms[d.short_form] = d;
                        })
                        var tmp = {}
                        tmp[efoid] = terms;
                        return tmp;
                    })
                }
                else {
                    console.log('no descendant found for ' + efoid);
                    return new Promise(function(resolve, reject) {
                        resolve({});
                    })
                }
            })
        }



        var dataPromise = getPromiseFromTag(global_efo_info_tag_id, 'efoDecendants');

        return dataPromise.then(function(data) {
            if ($.inArray(efoid, Object.keys(data)) == -1) {
                //efo descendant not currently loaded
                console.log('Loading descendant for ' + efoid)
                dataPromise = queryDescendant(efoid);
                return dataPromise.then(function(data){
                    //add to tag
                    addPromiseToTag(global_efo_info_tag_id,dataPromise,'efoDecendants');
                    return data[efoid];
                })
            }else {
                //efo colour is has been loaded perviously
                console.debug('Loading descendant from cache for ' + efoid);
                return data[efoid]
            }
        })
    }


    addPromiseToTag = function(tagID, promise, key, overwriteWarning) {
        overwriteWarning = overwriteWarning || false;

        var oldPromise = $(tagID).data(key) || new Promise(function(resolve){
                    resolve({})
                });


        var result;
        var p = Promise.all([oldPromise,promise]).then(function(arrayPromise){
                oldData = arrayPromise[0]
                newData = arrayPromise[1]

                if(overwriteWarning){
                    var overlap = Object.keys(oldData).filter(function(n) {
                        return Object.keys(newData).indexOf(n) > -1;
                    });
                    if (overlap.length > 0) {
                        overlap.forEach(function(d) {
                            console.log(d + 'will be overwritten.')
                        })
                    }
                }
                result = $.extend({}, oldData, newData)
                return result;
            });


        p.then(function(){
            $(global_efo_info_tag_id).data(key,p);
            console.debug('adding promise to ' + key + ' tag ' + tagID);
        })
    }
    getPromiseFromTag = function(tagID,key){
        var dataPromise =  getDataFromTag(tagID,key)
        if (dataPromise == undefined) {
            dataPromise = new Promise(function(resolve){
                resolve({});
            })
        }
        return dataPromise;
    }

    //When ploting with descendants, the number of efos increase drmatically.
    //This is to remove the efos that have no annotation in GWAS catalog,
    //Thus querying/ploting only those have at lease one annotation
    filterAvailableEFOs = function(toBeFilter) {
        availableEFOs = getDataFromTag(global_efo_info_tag_id, 'availableEFOs')
        if(availableEFOs)
            return toBeFilter.filter(function(n) {
                return Object.keys(availableEFOs).indexOf(n) !== -1;
            });
    }

    addEFO = function(data, initLoad, include_descendants) {
        include_descendants = include_descendants || false;
        initLoad = initLoad || false;

        //load all available efo terms in the GWAS Catalog(has at least one annotation)
        //save in the global_efo_info_tag_id tag with key 'availableEFOs'
        p = getAvailableEFOs();

        selected = addDataToTag(global_efo_selected_tag_id, data, 'selectedEfos')
        Promise.all(Object.keys(data).map(getHierarchicalDescendants)).then(function() {
            console.log('finish loading descendants!'
            )
        });

        //p is the promise for loading all available efo from GWAS Catalog
        //This needs to be fullfill first before trigger any add event.
        p.then(function() {
            $(global_efo_selected_tag_id).trigger('addToSelect', [include_descendants, initLoad]);
        }).catch(function(err) {
            console.error('Error when loading all available EFOs ' + err)
        });
    }

    $(global_efo_selected_tag_id).on('addToSelect', function(e, include_descendants, initLoad) {
        current_select = $(global_efo_selected_tag_id).data('selectedEfos')
        //print out terms:
        text = '';
        $.each(current_select, function(index, value) {
            text = text + index + ':' + value + '<br/>';
        });
        $("#selected-efos_text").html(text);

        $("#sharable_link").attr('value', window.location.origin + window.location.pathname + '?included=' +
                                 Object.keys(current_select).join(','))
        if (include_descendants) {
            all_descendants = {}
            Promise.all(Object.keys(current_select).map(getHierarchicalDescendants)).then(function(descendants) {
                descendants.forEach(function(terms) {
                    terms.forEach(function(term) {
                        all_descendants[term] = terms[term];
                    })
                })

                var searchTerm = $('#query').text();
                getEfoTraitData(searchTerm, Object.keys(current_select), Object.keys(all_descendants), initLoad);

            }).catch(function(err) {
                console.log('error when trying to find all descendants with error messgae ' + err);
            }).then(function() {
                //close spinner or something
            })
        }
        else {
            var searchTerm = $('#query').text();
            getEfoTraitbData(searchTerm, Object.keys(current_select), [], initLoad);
        }
    });





    //xintodo add/remove terms when select/disselect terms
    addEFO_bk = function(data, initLoad, include_descendants) {
        include_descendants = include_descendants || false;
        initLoad = initLoad || false;

        //load all available efo terms in the GWAS Catalog(has at least one annotation)
        //save in the global_efo_info_tag_id tag with key 'availableEFOs'
        p = new Promise(function(resolve, reject) {
            resolve('');
        })


        if (initLoad) {
            p = promiseGet('/gwas/api/search/efotrait', {
                'q': '*:*',
                'max': 9999,
                'fq': 'resourcename:efotrait',
                'group.limit': 9999
            }).then(JSON.parse).then(function(data) {
                tmp = {};
                $.each(data.grouped.resourcename.groups, function(index, group) {
                    switch (group.groupValue) {
                        case "efotrait":
                            available_efos_docs = group.doclist.docs;
                            break;
                        default:
                    }
                });
                available_efos_docs.forEach(function(doc) {
                    if (doc.shortForm) {
                        tmp[doc.shortForm[0]] = doc;
                    }
                });
                addDataToTag(global_efo_info_tag_id, tmp, 'availableEFOs');
                return data;
            })
        }

        selected = addDataToTag(global_efo_selected_tag_id, data, 'selectedEfos')
        Promise.all(Object.keys(data).map(findAllHierarchicalDescendants)).then(function() {
            console.log('finish loading descendants!'
            )
        });

        //p is the promise for loading all available efo from GWAS Catalog
        //This needs to be fullfill first before trigger any add event.
        p.then(function() {
            $(global_efo_selected_tag_id).trigger('addToSelect', [include_descendants, initLoad]);
        }).catch(function(err) {
            console.error('Error when loading all available EFOs ' + err)
        });
    }


    $(global_efo_selected_tag_id).on('addToSelectbk', function(e, include_descendants, initLoad) {
        current_select = $(global_efo_selected_tag_id).data('selectedEfos')
        //print out terms:
        text = '';
        $.each(current_select, function(index, value) {
            text = text + index + ':' + value + '<br/>';
        });
        $("#selected-efos_text").html(text);

        $("#sharable_link").attr('value', window.location.origin + window.location.pathname + '?included=' +
                                 Object.keys(current_select).join(','))
        if (include_descendants) {
            all_descendants = {}
            Promise.all(Object.keys(current_select).map(findAllHierarchicalDescendants)).then(function(descendants) {
                descendants.forEach(function(terms) {
                    terms.forEach(function(term) {
                        all_descendants[term] = terms[term];
                    })
                })

                var searchTerm = $('#query').text();
                getEfoTraitData(searchTerm, Object.keys(current_select), Object.keys(all_descendants), initLoad);

            }).catch(function(err) {
                console.log('error when trying to find all descendants with error messgae ' + err);
            }).then(function() {
                //close spinner or something
            })
        }
        else {
            var searchTerm = $('#query').text();
            getEfoTraitData(searchTerm, Object.keys(current_select), [], initLoad);
        }
    });



    /*]]>*/
</script>


<!--ols-->
<script>

    var app = require("ols-treeview");
    var instance = new app();

    options = {
        checkbox: false,
        checkbox_cascade: '',
        checkbox_three_state: false,
        checkbox_keep_selected_style: false,
//        onchange: function(e, data) {
////            console.log("newly selected:")
////            console.log(data.changed.selected);
////            console.log("newly deselected:")
////            console.log(data.changed.deselected);
////            console.log("event passed to onChange:")
////            console.log(e); // newly selected
////            console.log("data passed to onChange:")
////            console.log(data); // newly deselected
////            console.log(data.instance.get_selected(true));
//            elements = {};
//            if (data.instance.get_selected(true).length > 0) {
//                $.each(data.instance.get_selected(true), function(index, term) {
//                    if (term.original.iri) {
//                        elements['EFO_' + term.original.iri.split('EFO_')[1]] = term.original.text;
//                    }
//                });
//                //xintodo tree load
//                addEFO(elements);
////                console.log(data.instance.get_node(data.selected));
//            }
//        },
    }


    var searchTerm = $('#query').text();
    // initialise the tree
    //xintodo tempral disable for offline debug
    instance.draw($("#term-tree"),
                  false,
                  "efo",
                  "terms",
                  "http://www.ebi.ac.uk/efo/" + searchTerm,
                  "http://www.ebi.ac.uk/ols/",
                  options);


</script>

<!--ols search-->
<script>

    searchOLS = function(keyword,params){
        params = $.extend({}, params, {'q':keyword});
        return promiseGet(global_ols_seach_api,params).then(JSON.parse).then(function(data){
            console.log("data returned by ols search:");
            console.log(data);
            return data;
        })

    }


    findRelatedTermsoLocal = function(efoid) {
        var data = getDataFromTag(global_efo_info_tag_id, 'relatedEFOs')
        if(data==undefined)
            return undefined;
        return data[efoid]
    }

    findRelatedTerms = function(efoid){
        var relatedTermsLocal = findRelatedTermsoLocal(efoid)
        if (relatedTermsLocal) {
            return new Promise(function(resolve, reject) {
                resolve(relatedTermsLocal);
            })
        }

        return searchOLS($('#query').text(),{
            'ontology': 'efo',
            'fieldList': 'iri,ontology_name,ontology_prefix,short_form,description,id,label,is_defining_ontology,obo_id,type,logical_description'
        }).then(function(data){
            var terms = {};
            data.response.docs.forEach(function(d) {
                d.obo_id = d.obo_id.replace(":", "_")
                terms[d.obo_id] = d
            })
            addDataToTag(global_efo_info_tag_id,terms,'relatedEFOs');
            return terms;
        }).catch(function(err){
            console.error('Error when finding related term from OLS for keywork ' + keyword + '. ' + err);
        });
    }





    //checkbox approach
    findRelatedTerms($('#query').text()).then(function(terms){
        //make checkbox
        Object.keys(terms).forEach(function(relatedTerm){
            var d = terms[relatedTerm];
            addCheckbox('cb' + d.obo_id, d.obo_id + ' : ' + d.label, 'efocheckbox');
            $("#" + 'whycb' + d.obo_id).html(d.logical_description);
            if (d.obo_id == $('#query').text()) {
                $("#cb" + d.obo_id).attr("checked", true);
            }
        })

        //add check event.
        $(".efocheckbox").change(function() {
            var elements = {};
            $('.efocheckbox:input:checked').each(function(cb) {
                elements[$(this).attr('value').split(" : ")[0]] = $(this).attr('value').split(" : ")[1];
            });
            addEFO(elements);
        });
    })

    //ols-graph approach
    var tmpnetworkOptions = {
        webservice: {
//            URL: "http://www.ebi.ac.uk/ols/api/ontologies/cmpo/terms/http%253A%252F%252Fpurl.obolibrary.org%252Fobo%252FCHEBI_33839/graph",
            OLSschema: false
        },
        displayOptions: {showButtonBox: true, showInfoWindow: false, showLegend: true},
        callbacks: {
            onSelectNode:function(params){console.log(params); alert("This is callback replacing the inital functionality - onSelectNode")},
            onDoubleClick: function(params) {
                console.log(params.nodes[0]);

                addT
                alert(params)
            },
            //onSelectEdge:function(params){console.log(params); alert("Now you selected on an Edge - event:onSelectEdge")},
//            onClick: function(params) {
//                console.log(params);
//                alert("You clicked somewhere in the graph! - onClick event (single)")
//            }
        }
    }

    var visoptions = {
        physics: {
            forceAtlas2Based: {
                gravitationalConstant: -50,
                centralGravity: 0.01,
                springConstant: 0.08,
                springLength: 100,
                damping: 0.4,
                avoidOverlap: 0
            },
        },
        layout: {
            hierarchical: false
        },
        nodes: {
            borderWidth: 5,
            shape: 'ellipse'
        },
        edges: {
            arrows: {middle: {enabled: true}},
            dashes: true,
        },

    }

    var term = "Can be whatever at the moment - if you chose OLSschema false"

    var app = require("ols-graphview");
    var instance = new app();

    instance.visstart("ontology_vis", term, tmpnetworkOptions, visoptions);



    /* Demonstration of public functions somebody might want to use*/
//    instance.printMsg("Message from outside should demonstrate how to use the print function");
//    instance.fetchNewGraphData(
//            "http://www.ebi.ac.uk/ols/api/ontologies/cmpo/terms/http%253A%252F%252Fpurl.obolibrary.org%252Fobo%252FCHEBI_15841/graph");
//    instance.fetchNewGraphData(
//            "http://www.ebi.ac.uk/ols/api/ontologies/cmpo/terms/http%253A%252F%252Fpurl.obolibrary.org%252Fobo%252FCHEBI_23367/graph");

    console.log(
            "These are empty during loading, but you could use them later on in the process to get this information:")
    console.log(instance.getExtendedNodes());
    console.log(instance.getRelationships());



    //ols search
    //xintodo tempral disable for offline debug
//    $.getJSON('http://www.ebi.ac.uk/ols/api/search',
//              {
//                  'q': $('#query').text(),
//                  'ontology': 'efo',
//                  'fieldList': 'iri,ontology_name,ontology_prefix,short_form,description,id,label,is_defining_ontology,obo_id,type,logical_description'
//              })
//            .done(function(data) {
//                console.log("data returned by ols search:");
//                console.log(data);
//
//                data.response.docs.forEach(function(d, i) {
//                    d.obo_id = d.obo_id.replace(":", "_")
//                    addCheckbox('cb' + d.obo_id, d.obo_id + ' : ' + d.label, 'efocheckbox');
//                    $("#" + 'whycb' + d.obo_id).html(d.logical_description);
////                    $("#"+'whycb'+d.obo_id).html(longContentList("#"+'whycbhiddent'+d.obo_id, ['a','b'], 'why'))
//                    if (d.obo_id == $('#query').text()) {
//                        $("#cb" + d.obo_id).attr("checked", true);
//                    }
//                })
//
//
//                $(".efocheckbox").change(function() {
////                    console.log($('input:checked'));
//                    elements = {};
//                    $('input:checked').each(function() {
//                        elements[$(this).attr('value').split(" : ")[0]] = $(this).attr('value').split(" : ")[1];
//                    });
////                    xintodo checkbox load
//                    addEFO(elements);
//                });
//            });


    function addCheckbox(id, name, cbclass) {
        var container = $('#expension');
        $('<input />', {type: 'checkbox', id: id, class: cbclass, value: name}).appendTo(container);
        $('<label />', {'for': id, text: name}).appendTo(container);
        $('<div />', {'id': 'why' + id}).appendTo(container);

        $('<br />').appendTo(container);

    }
</script>

<!--ols auto complete-->
<script>
    //xintodo tempral disable for offline debug
    $(document).ready(function() {
        var app = require("ols-autocomplete");
        var instance = new app();
        options = {
            action: function(relativePath, suggestion_ontology, type, iri) {
//                console.log("In overwritten function")
//                console.log("Relative Path: " + relativePath)
//                console.log("Suggested Ontology: " + suggestion_ontology)
//                console.log("Type (optional): " + type)
//                console.log("iri (optional): " + iri)
                elements = {};
                elements['EFO_' + iri.split("EFO_")[1]] = 'EFO_' + iri.split("EFO_")[1];
                //xintodo auto load
                addEFO(elements);
            }
        }
        instance.start(options)
    });


</script>

<!--visjs-->
<style type="text/css">
    /*#mynetwork {*/
    /*width: 600px;*/
    /*height: 400px;*/
    /*border: 1px solid lightgray;*/
    /*}*/
</style>
<!--<script>-->
<!--//http://visjs.org/docs/network/-->
<!--// create an array with nodes-->
<!--var nodes = new vis.DataSet([-->
<!--{id: 1, label: 'Node 1'},-->
<!--{id: 2, label: 'Node 2'},-->
<!--{id: 3, label: 'Node 3'},-->
<!--{id: 4, label: 'Node 4'},-->
<!--{id: 5, label: 'Node 5'}-->
<!--]);-->

<!--// create an array with edges-->
<!--var edges = new vis.DataSet([-->
<!--{from: 1, to: 3},-->
<!--{from: 1, to: 2},-->
<!--{from: 2, to: 4},-->
<!--{from: 2, to: 5}-->
<!--]);-->

<!--// create a network-->
<!--var container = document.getElementById('mynetwork');-->

<!--// provide the data in the vis format-->
<!--var data = {-->
<!--nodes: nodes,-->
<!--edges: edges-->
<!--};-->

<!--var options = {-->
<!--//        //this can be used to find a good style for the plot.-->
<!--//        configure: {-->
<!--//            enabled: true,-->
<!--//            filter: 'nodes,edges',-->
<!--//            container: undefined,-->
<!--//            showButton: true-->
<!--//        }-->
<!--interaction: {-->
<!--dragNodes: true,-->
<!--dragView: true,-->
<!--hideEdgesOnDrag: false,-->
<!--hideNodesOnDrag: false,-->
<!--hover: false,-->
<!--hoverConnectedEdges: true,-->
<!--keyboard: {-->
<!--enabled: false,-->
<!--speed: {x: 10, y: 10, zoom: 0.02},-->
<!--bindToWindow: true-->
<!--},-->
<!--multiselect: false,-->
<!--navigationButtons: false,-->
<!--selectable: true,-->
<!--selectConnectedEdges: true,-->
<!--tooltipDelay: 300,-->
<!--zoomView: true-->
<!--}-->
<!--}-->

<!--// initialize your network!-->
<!--//    var network = new vis.Network(container, data, options);-->
<!--</script>-->


<!--ols_graph-->
<script>
//    var tmpnetworkOptions = {
//        webservice: {
//            URL: "http://www.ebi.ac.uk/ols/api/ontologies/cmpo/terms/http%253A%252F%252Fpurl.obolibrary.org%252Fobo%252FCHEBI_33839/graph",
//            OLSschema: false
//        },
//        displayOptions: {showButtonBox: true, showInfoWindow: false, showLegend: true},
//        callbacks: {
//            //onSelectNode:function(params){console.log(params); alert("This is callback replacing the inital functionality - onSelectNode")},
//            onDoubleClick: function(params) {
//                console.log(params);
//                alert("WE did overwrite the DOUBLE click event as well")
//            },
//            //onSelectEdge:function(params){console.log(params); alert("Now you selected on an Edge - event:onSelectEdge")},
//            onClick: function(params) {
//                console.log(params);
//                alert("You clicked somewhere in the graph! - onClick event (single)")
//            }
//        }
//    }
//
//    var visoptions = {
//        physics: {
//            forceAtlas2Based: {
//                gravitationalConstant: -50,
//                centralGravity: 0.01,
//                springConstant: 0.08,
//                springLength: 100,
//                damping: 0.4,
//                avoidOverlap: 0
//            },
//        },
//        layout: {
//            hierarchical: false
//        },
//        nodes: {
//            borderWidth: 5,
//            shape: 'ellipse'
//        },
//        edges: {
//            arrows: {middle: {enabled: true}},
//            dashes: true,
//        },
//
//    }
//
//    var term = "Can be whatever at the moment - if you chose OLSschema false"
//
//    var app = require("ols-graphview");
//    var instance = new app();
//
//    instance.visstart("ontology_vis", term, tmpnetworkOptions, visoptions);
//
//
//    /* Demonstration of public functions somebody might want to use*/
//    instance.printMsg("Message from outside should demonstrate how to use the print function");
//    instance.fetchNewGraphData(
//            "http://www.ebi.ac.uk/ols/api/ontologies/cmpo/terms/http%253A%252F%252Fpurl.obolibrary.org%252Fobo%252FCHEBI_15841/graph");
//    instance.fetchNewGraphData(
//            "http://www.ebi.ac.uk/ols/api/ontologies/cmpo/terms/http%253A%252F%252Fpurl.obolibrary.org%252Fobo%252FCHEBI_23367/graph");
//
//    console.log(
//            "These are empty during loading, but you could use them later on in the process to get this information:")
//    console.log(instance.getExtendedNodes());
//    console.log(instance.getRelationships());


</script>

</body>
</html>
<!--//EFO:0000400-->
<!--//    http://localhost:8280/gwas/beta/efotrait/EFO_0000400-->
<!--https://wwwdev.ebi.ac.uk/gwas/beta/rest/docs/index-->
<!--https://wwwdev.ebi.ac.uk/gwas/beta/rest/api/efoTraits/search-->
<!--https://wwwdev.ebi.ac.uk/gwas/beta/rest/api/efoTraits-->
<!--https://wwwdev.ebi.ac.uk/gwas/beta/rest/api-->
<!--https://wwwdev.ebi.ac.uk/gwas/beta/rest/api/efoTraits/71-->
<!--https://wwwdev.ebi.ac.uk/gwas/beta/rest/api/efoTraits/search/findByUri?uri=http://www.ebi.ac.uk/efo/EFO_0000400-->
<!--https://michigangenomics.org/genetic_data.html-->
<!--https://github.com/statgen/locuszoom/wiki/Data-Sources-->
<!--http://wwwdev.ebi.ac.uk/gwas/beta/rest/api/parentMapping/EFO_0000400-->
<!--xintodo get request too long-->