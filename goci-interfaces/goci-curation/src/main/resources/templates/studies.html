<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>GWAS Curation Tool</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <meta charset="utf-8"/>
    <link rel="icon" th:href="@{/icons/favicon.ico}"/>

    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/css/bootstrap-theme.min.css}"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

    <link href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/css/select2.min.css" rel="stylesheet"/>
    <script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/js/select2.min.js"></script>
    <link th:href="@{/css/select2-bootstrap.css}" rel="stylesheet"/>

   <!-- Bootstrap core CSS -->
    <!--<link href="../../static/css/bootstrap.css" th:href="@{css/bootstrap.min.css}" rel="stylesheet"/>-->
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css"
          rel="stylesheet"/>
    <link th:href="@{/css/bootstrap-table.css}" rel="stylesheet"/>
    <!--<link href="../static/css/bootstrap-theme.css" th:href="@{css/bootstrap-theme.min.css}" rel="stylesheet"/>-->

   <!-- Custom styles for this template -->
    <link th:href="@{/css/jumbotron.css}" rel="stylesheet"/>
    <link th:href="@{/css/sticky-footer-navbar.css}" rel="stylesheet"/>

   <!-- Additional styling on top of bootstrap -->
    <link rel="stylesheet" th:href="@{/css/goci-curation.css}"/>
    <link rel="stylesheet" th:href="@{/css/icons/flaticon.css}"/>
    <link rel="stylesheet" th:href="@{/css/goci-color-palette-1.css}"/>


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script th:src="@{/js/matrix.js}"></script>
    <script th:src="@{/js/console-plugin.js}"></script>
    <script th:src="@{/js/goci-print-page.js}"></script>
    <script th:src="@{/js/goci-show-text.js}"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.13.3/math.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        window.studyScoreFeatures = /*[[${scoreFeatures}]]*/ null;
        /*]]>*/
    </script>
</head>
<body>

<!--Include header-->
<div th:include="fragments/header :: navbar"></div>


<!--Include filter-->
<div th:include="fragments/study_filter :: filter"></div>
<br/>


<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">

            <!--Alerts-->
            <div class="container-fluid" th:if="${!#strings.isEmpty(studySnpsNotApproved)}">
                <div class="row">
                    <div class="col-md-8">
                        <div class="alert alert-danger">
                            <a href="#" class="close" data-dismiss="alert">&times;</a>
                            <strong th:text="${studySnpsNotApproved}">Note:</strong>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container-fluid" th:if="${!#strings.isEmpty(blankAssignee)}">
                <div class="row">
                    <div class="col-md-8">
                        <div class="alert alert-danger">
                            <a href="#" class="close" data-dismiss="alert">&times;</a>
                            <strong th:text="${blankAssignee}">Note:</strong>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container-fluid" th:if="${!#strings.isEmpty(blankStatus)}">
                <div class="row">
                    <div class="col-md-8">
                        <div class="alert alert-danger">
                            <a href="#" class="close" data-dismiss="alert">&times;</a>
                            <strong th:text="${blankStatus}">Note:</strong>
                        </div>
                    </div>
                </div>
            </div>
            <br/>


            <div>
                <ul class="nav nav-pills">
                    <li class="active"><a th:href="@{/studies}">All studies</a></li>
                    <br/>
                </ul>
            </div>

            <!--Table-->
            <!--Two different table views available depending on if any results are found-->
            <div th:if="${totalStudies == 0}" th:include="fragments/studies_emptytable :: empty_table"></div>
            <div th:if="${totalStudies &gt; 0}" th:include="fragments/studies_table_with_results :: results_table"></div>
        </div>

        <!--Only show bar if more that one study available and pagination is set to true-->
        <div th:if="${totalStudies &gt; 1 and #bools.isTrue(pagination) }"
             th:include="fragments/pagination_bar :: pagination_bar"></div>
    </div>
</div>

<div th:include="fragments/footer :: page_footer"></div>


<script>
    /*<![CDATA[*/

//    var studies = JSON.parse(JSON.stringify(window.studyScoreFeatures));

//    console.log('studies from server:');
//    console.log(studies);


    hashFromArrays = function(arr_keys,arr_values){
        if(arr_keys.length != arr_values.length){
            console.error('the number of keys(' + arr_keys + ') must be the same of the number of values(' + arr_values + ')!')
            return undefined;
        }
        var hash = {}
        arr_keys.forEach(function(i) {
            hash[i] = arr_values.shift();
        })
        return hash;
    }


    objectMap = function(object,func) {
        var keys = Object.keys(object);
        var values = Object.values(object)
        return hashFromArrays(keys, values.map(func))
    }


    var score = {
        sum : (a,b)=>{return a+b},
        normalizeByMax : (array,scale=1,keys=undefined) => {
            array = array.map(parseFloat);
            var min = Math.min(...array)
            var max = Math.max(...array)
            var normalized = array.map((v)=> {
                if (min == max) return 1*scale;
                return scale * (v - min)  / (max - min);
            })
            if(keys != undefined){
                return hashFromArrays(keys,normalized);
            }
            return normalized;
        },
        takeLog : (array,keys=undefined) => {
            array = array.map(parseFloat);
            var normalized = array.map((v)=>{
                //avoid 0
                return Math.log(v+1);
            })
            if(keys != undefined){
                return hashFromArrays(keys,normalized);
            }
            return normalized;
        },
        normalizeBySum : (array,scale=1,keys=undefined) => {
            var total = array.reduce(score.sum,0);
            var normalized = array.map((v)=> {
                if (total ==0 ) return 0;
                return scale * v/total;
            })
            if(keys != undefined){
                return hashFromArrays(keys,normalized);
            }
            return normalized;
        },
    }

    /**
     * get data asyn with promise
     * @param {String} url
     * @param {hash} params
     * @param {Boolean} debug
     * @returns {Promise}
     */
    function promiseGet(url, params,debug) {
        if(debug == undefined){
            debug = false
        }

        if (!url.startsWith("http")) {
            url = window.location.origin + url
        }

        // Return a new promise.
        return new Promise(function(resolve, reject) {
            // Do the usual XHR stuff
            var req = new XMLHttpRequest();

            params = params || {}
            if (Object.keys(params).length > 0) {
                var params_str = '';
                Object.keys(params).forEach(function(key, index) {
                    params_str = params_str + '&' + key + '=' + this[key];
                }, params);
                url = url + '?' + params_str.substring(1);
            }

            req.open('GET', url);
            if(debug){
                console.log('promise get from :' + url);
            }

            req.onload = function() {
                // This is called even on 404 etc
                // so check the status
                if (req.status == 200) {
                    // Resolve the promise with the response text
                    resolve(req.response);
                }
                else {
                    // Otherwise reject with the status text
                    // which will hopefully be a meaningful error
                    reject(Error(req.statusText));
                }
            };

            // Handle network errors
            req.onerror = function() {
                reject(Error("Network Error"));
            };

            // Make the request
            req.send();
        });
    }


    function printResult(studies,FEATURES){
        var array = [];
        array.push([''].concat(Object.keys(FEATURES)))
        Object.keys(studies).map((study_id)=>{
            var row = [study_id];
            Object.keys(FEATURES).map((feature)=>{
                row = row.concat(studies[study_id][feature])
            })
            array.push(row);
            return row;
        })
        var A = matrix(array);
//        console.log(A([],[]))
        console.log(
                JSON.stringify(A([],[]))
        );
    }


    function buildMap(obj,deep=true) {
        if(map==undefined)
            map=new Map();

        Object.keys(obj).forEach(key => {
            var tmp=obj[key];
            if(deep){
                if(obj[key] !== null && typeof obj[key] === 'object'){
                    tmp = buildMap(obj[key],map,true)
                }
            }
            map.set(key, tmp);
        });
        return map;
    }


    var FEATURES = {
        InitialSampleSize : 10.5,
//        ReplicateSampleSize : 8.09,
        GenomeWideCoverage : 8.95,
        SummaryStatisticsAvailable : 8.56, //dont know yet
        UserRequested : 8.56, //dont know yet
        ReplicationStageIncluded : 8.09,
        PublicationDate : 6.7,
    }
    var needTakeLog = ['InitialSampleSize','PublicationDate']
//    var FEATURES = {
//        InitialSampleSize : 1,
////        ReplicateSampleSize : 8.09,
//        GenomeWideCoverage : 1,
//        SummaryStatisticsAvailable : 1, //dont know yet
//        UserRequested : 1, //dont know yet
//        ReplicationStageIncluded : 1,
//        PublicationDate : 1,
//
//    }

    FEATURES_NOMALIZED = score.normalizeBySum(Object.values(FEATURES),1,Object.keys(FEATURES))




    promiseGet('/gwas/curation/studyscore').then(JSON.parse).then((studies)=>{
        studies_raw = studies;
        //debug
//        studies[999999999999] = {
//            Author : 'abc',
//            PubmedId : '12345',
//            GenomeWideCoverage : 1,
//            InitialSampleSize : 9999999,
//            GenomeWideCoverage : 1,
//            SummaryStatisticsAvailable : 1, //dont know yet
//            UserRequested : 1, //dont know yet
//            ReplicationStageIncluded : 1,
//            PublicationDate : '2005-04-25 00:00:00.0',
//        }
        //CLEAN STUDY DATA, replace null,na,undefined,false to 0, true to 1
        studies_clean=JSON.parse(JSON.stringify(studies))
        Object.keys(studies_clean).map((study_id)=>{
            Object.keys(studies_clean[study_id]).map((feature)=>{
                //remove element that is not a feature
                if(Object.keys(FEATURES_NOMALIZED).indexOf(feature) == -1){
                    delete studies_clean[study_id][feature]
                }else{
                    var value = studies_clean[study_id][feature];
                    //clean
                    if(value == undefined | value==null | value === 'false' | value == "NA") {
                        value = 0;
                    }
                    if(value == 'true'){
                        value = 1;
                    }
                    if(feature == 'PublicationDate'){
                        value = new Date() - new Date(value)
                    }
                    studies_clean[study_id][feature] = value;
                }
            })
        })
        console.log('Clean null,na,undefined,false and true...');
        console.log(studies_clean);


        //group all feature together for nomolization across studies
        groupByFeatures={};
        Object.keys(FEATURES).map((feature)=>{
            groupByFeatures[feature] ={};
            Object.keys(studies_clean).map((study)=>{
                groupByFeatures[feature][study] = studies_clean[study][feature]
            })
        })
        console.log('Group by features:');
        console.log(groupByFeatures);

        groupByFeatures_nomalized = JSON.parse(JSON.stringify(groupByFeatures))
        Object.keys(groupByFeatures_nomalized).map((feature)=>{
            var featureObject = groupByFeatures_nomalized[feature];
            if(needTakeLog.indexOf(feature) != -1){
                //take log before nomalize
                featureObject = score.takeLog(Object.values(groupByFeatures_nomalized[feature]),Object.keys(groupByFeatures_nomalized[feature]));
            }
            groupByFeatures_nomalized[feature] = score.normalizeByMax(Object.values(featureObject),100,Object.keys(featureObject))
        })
        console.log('Group by features nomalized:');
        console.log(groupByFeatures_nomalized);

        studies_nomalized = JSON.parse(JSON.stringify(studies_clean))
        Object.keys(groupByFeatures_nomalized).map((feature)=>{
            Object.keys(groupByFeatures_nomalized[feature]).map((study)=>{
                studies_nomalized[study][feature]=groupByFeatures_nomalized[feature][study]
            })
        })
        console.log('study nomalized:');
        console.log(studies_nomalized);


        studies_nomalized_weighted = JSON.parse(JSON.stringify(studies_nomalized))
        Object.keys(studies_nomalized_weighted).map((study_id)=>{
            Object.keys(studies_nomalized_weighted[study_id]).map((feature)=>{
                studies_nomalized_weighted[study_id][feature] = studies_nomalized_weighted[study_id][feature] * FEATURES_NOMALIZED[feature]
            })
        })
        console.log('study nomalized weighted:');
        console.log(studies_nomalized_weighted);

        studies_score={}
        Object.keys(studies_nomalized_weighted).map((study)=>{
            studies_score[study] = Object.values(studies_nomalized_weighted[study]).reduce(score.sum,0)
        });
        console.log('study score:');
        console.log(studies_score);

        fakePrintMatrix(studies,FEATURES_NOMALIZED)
        fakePrintMatrix(studies_clean,FEATURES_NOMALIZED)
        fakePrintMatrix(studies_nomalized,FEATURES_NOMALIZED)
        fakePrintMatrix(studies_nomalized_weighted,FEATURES_NOMALIZED,studies_score)

        studies_ordered = getSortedKeys(studies_score)
        studies_ordered.map((key)=>{

            var title = Object.keys(studies_raw[key]).map((features)=>{
                if(Object.keys(FEATURES).indexOf(features) != -1){
                    return features + ':' +studies_raw[key][features];
                }
                return '';
            }).filter((x)=>{return x!='';}).join('\n');

            var title2 = Object.keys(studies_nomalized[key]).map((features)=>{
                if(Object.keys(FEATURES).indexOf(features) != -1){
                    return features + ':' +studies_nomalized[key][features];
                }
                return '';
            }).filter((x)=>{return x!='';}).join('\n');

            var item = $('<a />', {
                class: 'list-group-item col-xs-11',
                title: key,
            }).appendTo($('#study-score'));
//            item.append(key);
            item.append(studies[key]['PubmedId'] + ' ' + studies[key]['Author']);


            $('<span />', { class: 'badge', text: studies_score[key].toFixed(2), title:title + '\n\n' +title2,}).appendTo(item);
            var link = $('<span />', { class: 'glyphicon glyphicon-new-window external-link'}).css({'float':'right'}).appendTo(item);

            link.click(() => {
                window.open(window.location.pathname+'/'+key, '_blank');
            })
        })


    })

    fakePrintMatrix = function(studies,features,score=undefined,colsep='\t\t\t',rowsep='\n'){
        console.log('\t'+Object.keys(features).join('\t') + rowsep);
        console.log('nomalized weight\t' + Object.values(features).join(colsep)+ rowsep);
        var matrixString = ''
        Object.keys(studies).map((study_id)=>{
            matrixString = matrixString.concat(study_id + colsep);
            Object.keys(features).map((feature)=>{
                matrixString = matrixString.concat(studies[study_id][feature]+colsep);
            })
            if(score){
                matrixString = matrixString.concat(score[study_id]);
            }
            matrixString = matrixString.concat(rowsep);

        })
        console.log(matrixString)
    }

    function getSortedKeys(obj) {
        var keys = []; for(var key in obj) keys.push(key);
        return keys.sort(function(a,b){return obj[b]-obj[a]});
    }



    /*]]>*/
</script>
</body>
</html>