<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>GWAS Curation Tool</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <meta charset="utf-8"/>
    <link rel="icon" th:href="@{/icons/favicon.ico}"/>

    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/css/bootstrap-theme.min.css}"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

    <link href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/css/select2.min.css" rel="stylesheet"/>
    <script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/js/select2.min.js"></script>
    <link th:href="@{/css/select2-bootstrap.css}" rel="stylesheet"/>

    <!-- Bootstrap core CSS -->
    <!--<link href="../../static/css/bootstrap.css" th:href="@{css/bootstrap.min.css}" rel="stylesheet"/>-->
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css"
          rel="stylesheet"/>
    <link th:href="@{/css/bootstrap-table.css}" rel="stylesheet"/>
    <!--<link href="../static/css/bootstrap-theme.css" th:href="@{css/bootstrap-theme.min.css}" rel="stylesheet"/>-->

    <!-- Custom styles for this template -->
    <link th:href="@{/css/jumbotron.css}" rel="stylesheet"/>
    <link th:href="@{/css/sticky-footer-navbar.css}" rel="stylesheet"/>

    <!-- Additional styling on top of bootstrap -->
    <link rel="stylesheet" th:href="@{/css/goci-curation.css}"/>
    <link rel="stylesheet" th:href="@{/css/icons/flaticon.css}"/>
    <link rel="stylesheet" th:href="@{/css/goci-color-palette-1.css}"/>


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script th:src="@{/js/console-plugin.js}"></script>
    <script th:src="@{/js/goci-print-page.js}"></script>
    <script th:src="@{/js/goci-show-text.js}"></script>
    <script th:src="@{/js/goci-study-score.js}"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.13.3/math.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
//        window.studyScoreFeatures = /*[[${scoreFeatures}]]*/ null;
        /*]]>*/
    </script>


</head>
<body>

<!--Include header-->
<div th:include="fragments/header :: navbar"></div>


<!--Include filter-->
<div th:include="fragments/study_filter :: filter"></div>
<br/>


<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">

            <!--Alerts-->
            <div class="container-fluid" th:if="${!#strings.isEmpty(studySnpsNotApproved)}">
                <div class="row">
                    <div class="col-md-8">
                        <div class="alert alert-danger">
                            <a href="#" class="close" data-dismiss="alert">&times;</a>
                            <strong th:text="${studySnpsNotApproved}">Note:</strong>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container-fluid" th:if="${!#strings.isEmpty(blankAssignee)}">
                <div class="row">
                    <div class="col-md-8">
                        <div class="alert alert-danger">
                            <a href="#" class="close" data-dismiss="alert">&times;</a>
                            <strong th:text="${blankAssignee}">Note:</strong>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container-fluid" th:if="${!#strings.isEmpty(blankStatus)}">
                <div class="row">
                    <div class="col-md-8">
                        <div class="alert alert-danger">
                            <a href="#" class="close" data-dismiss="alert">&times;</a>
                            <strong th:text="${blankStatus}">Note:</strong>
                        </div>
                    </div>
                </div>
            </div>
            <br/>


            <div>
                <ul class="nav nav-pills">
                    <li class="active"><a th:href="@{/studies}">All studies</a></li>
                    <br/>
                </ul>
            </div>

            <!--Table-->
            <!--Two different table views available depending on if any results are found-->
            <div th:if="${totalStudies == 0}" th:include="fragments/studies_emptytable :: empty_table"></div>
            <div th:if="${totalStudies &gt; 0}" th:include="fragments/studies_table_with_results :: results_table"></div>
        </div>

        <!--Only show bar if more that one study available and pagination is set to true-->
        <div th:if="${totalStudies &gt; 1 and #bools.isTrue(pagination) }"
             th:include="fragments/pagination_bar :: pagination_bar"></div>
    </div>
</div>

<div th:include="fragments/footer :: page_footer"></div>


<script>
    /*<![CDATA[*/

    var FEATURES = {
        InitialSampleSize : 10.5,
//        ReplicateSampleSize : 8.09,
        GenomeWideCoverage : 8.95,
        SummaryStatisticsAvailable : 8.56, //dont know yet
        UserRequested : 8.56, //dont know yet
        ReplicationStageIncluded : 8.09,
        PublicationDate : 6.7,
    }
    var needTakeLog = ['InitialSampleSize','PublicationDate']




    //    var FEATURES = {
    //        InitialSampleSizae : 1,
    ////        ReplicateSampleSize : 8.09,
    //        GenomeWideCoverage : 1,
    //        SummaryStatisticsAvailable : 1, //dont know yet
    //        UserRequested : 1, //dont know yet
    //        ReplicationStageIncluded : 1,
    //        PublicationDate : 1,
    //
    //    }




    //This object hold what the ajax call sends back, which is the an array of unplblished study objects
    var studies_meta;
    //ajax call
    var studiesPromise = getStudy().then((studies)=>{
        studies_meta = studies;
        return studies;
    })
    //work out score
    var scorePromise = studiesPromise.then((studies)=>{
        return calculateScore(studies,FEATURES,needTakeLog)
    })

    //add data to table
    scorePromise.then((studies_score)=>{
        $("#mainTable tr").each(function() {
            console.log(this);
            if (this.id != "") {
                var newValue = studies_score[this.id];
                $(this).find('#score').text(newValue);
            }
        });
    })

    //create a list of studies sorted by score
    scorePromise.then((studies_score)=>{

        var getSortedKeys = function(obj) {
            var keys = []; for(var key in obj) keys.push(key);
            return keys.sort(function(a,b){return obj[b]-obj[a]});
        }

        studies_ordered = getSortedKeys(studies_score)
        //generate the list for display
        studies_ordered.map((key)=>{
            var title = Object.keys(studies_raw[key]).map((features)=>{
                if(Object.keys(FEATURES).indexOf(features) != -1){
                    return features + ':' +studies_raw[key][features];
                }
                return '';
            }).filter((x)=>{return x!='';}).join('\n');

            var title2 = Object.keys(studies_nomalized[key]).map((features)=>{
                if(Object.keys(FEATURES).indexOf(features) != -1){
                    return features + ':' +studies_nomalized[key][features];
                }
                return '';
            }).filter((x)=>{return x!='';}).join('\n');

            var item = $('<a />', {
                class: 'list-group-item col-xs-11',
                title: key,
            }).appendTo($('#study-score'));
//            item.append(key);
            item.append(studies_meta[key]['PubmedId'] + ' ' + studies_meta[key]['Author']);


            $('<span />', { class: 'badge', text: studies_score[key].toFixed(2), title:title + '\n\n' +title2,}).appendTo(item);
            var link = $('<span />', { class: 'glyphicon glyphicon-new-window external-link'}).css({'float':'right'}).appendTo(item);

            link.click(() => {
                window.open(window.location.pathname+'/gwas'+key, '_blank');
            })
        })
    })




    /*]]>*/
</script>
</body>
</html>