<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>GWAS Curation Tool</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <meta charset="utf-8"/>
    <link rel="icon" th:href="@{/icons/favicon.ico}"/>

    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/css/bootstrap-theme.min.css}"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

    <link href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/css/select2.min.css" rel="stylesheet"/>
    <script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/js/select2.min.js"></script>
    <link th:href="@{/css/select2-bootstrap.css}" rel="stylesheet"/>

   <!-- Bootstrap core CSS -->
    <!--<link href="../../static/css/bootstrap.css" th:href="@{css/bootstrap.min.css}" rel="stylesheet"/>-->
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css"
          rel="stylesheet"/>
    <link th:href="@{/css/bootstrap-table.css}" rel="stylesheet"/>
    <!--<link href="../static/css/bootstrap-theme.css" th:href="@{css/bootstrap-theme.min.css}" rel="stylesheet"/>-->

   <!-- Custom styles for this template -->
    <link th:href="@{/css/jumbotron.css}" rel="stylesheet"/>
    <link th:href="@{/css/sticky-footer-navbar.css}" rel="stylesheet"/>

   <!-- Additional styling on top of bootstrap -->
    <link rel="stylesheet" th:href="@{/css/goci-curation.css}"/>
    <link rel="stylesheet" th:href="@{/css/icons/flaticon.css}"/>
    <link rel="stylesheet" th:href="@{/css/goci-color-palette-1.css}"/>


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script th:src="@{/js/console-plugin.js}"></script>
    <script th:src="@{/js/goci-print-page.js}"></script>
    <script th:src="@{/js/goci-show-text.js}"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.13.3/math.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        window.studyScoreFeatures = /*[[${scoreFeatures}]]*/ null;
//        window.studytest = /*[[${studytest}]]*/ null;
//        window.studyScoreFactor = {'20509599':{'InitialSampleSize':'13,086 European ancestry cases, 1,840 whole genome sequenced European ancestry cases, 2,119 Japanese ancestry cases, 60,699 European ancestry controls, 129,016 whole genome sequenced European ancestry controls, 2,143 Japanese ancestry controls.','Publication':'Nat Commun','GenomewideArray':'true','ReplicateSampleSize':'NA'},'20509610':{'InitialSampleSize':'6,592 European ancestry case-parent trios, 795 European ancestry child cases, 6,592 European ancestry child pseudocontrols, 1,975 European ancestry child controls','Publication':'Mol Autism','GenomewideArray':'true','ReplicateSampleSize':'up to 9,152 European ancestry child cases, up to 148,667 European ancestry child controls'},'19744811':{'InitialSampleSize':null,'Publication':'Circ Cardiovasc Genet','GenomewideArray':'true','ReplicateSampleSize':null},'20509659':{'InitialSampleSize':null,'Publication':'Stroke','GenomewideArray':'true','ReplicateSampleSize':null},'21346716':{'InitialSampleSize':null,'Publication':'Twin Res Hum Genet','GenomewideArray':'true','ReplicateSampleSize':null},'20509615':{'InitialSampleSize':null,'Publication':'Pharmacogenet Genomics','GenomewideArray':'true','ReplicateSampleSize':null},'21405446':{'InitialSampleSize':null,'Publication':'Nat Genet','GenomewideArray':'true','ReplicateSampleSize':null},'21405426':{'InitialSampleSize':null,'Publication':'Nat Commun','GenomewideArray':'true','ReplicateSampleSize':null},'21311803':{'InitialSampleSize':null,'Publication':'Diabetes','GenomewideArray':'true','ReplicateSampleSize':null},'20509592':{'InitialSampleSize':'11,988 European ancestry cases, 275,335 European ancestry controls','Publication':'Nat Commun','GenomewideArray':'true','ReplicateSampleSize':'7,044 European ancestry cases, 11,434 European ancestry controls'},'20509691':{'InitialSampleSize':null,'Publication':'Mol Psychiatry','GenomewideArray':'true','ReplicateSampleSize':null},'19605897':{'InitialSampleSize':'626 European ancestry individuals from families with at least two siblings','Publication':'J Nutr Intermed Metab','GenomewideArray':'true','ReplicateSampleSize':'NA'},'21405442':{'InitialSampleSize':null,'Publication':'Nat Genet','GenomewideArray':'true','ReplicateSampleSize':null},'21405422':{'InitialSampleSize':null,'Publication':'Sci Rep','GenomewideArray':'true','ReplicateSampleSize':null},'20509588':{'InitialSampleSize':'78,308 European ancestry individuals','Publication':'Nat Genet','GenomewideArray':'true','ReplicateSampleSize':'NA'},'20509683':{'InitialSampleSize':null,'Publication':'Schizophr Bull','GenomewideArray':'true','ReplicateSampleSize':null},'21287406':{'InitialSampleSize':'628 European ancestry cases, 1,840 whole genome sequenced European ancestry cases, 8,858 European ancestry controls, 129,016 whole genome sequenced European ancestry controls','Publication':'Nat Commun','GenomewideArray':'true','ReplicateSampleSize':'NA'},'21405450':{'InitialSampleSize':null,'Publication':'Am J Med Genet B Neuropsychiatr Genet','GenomewideArray':'true','ReplicateSampleSize':null},'21289497':{'InitialSampleSize':'up to 6,622 European ancestry cases, 1,840 whole genome sequenced European ancestry cases, up to 2,119 Japanese ancestry cases, 12,105 European ancestry controls, 129,016 whole genome sequenced European ancestry controls, 2,143 Japanese ancestry controls.','Publication':'Nat Commun','GenomewideArray':'true','ReplicateSampleSize':'NA'},'21405430':{'InitialSampleSize':null,'Publication':'Nat Commun','GenomewideArray':'true','ReplicateSampleSize':null},'21311811':{'InitialSampleSize':'310 European ancestry individuals with Alzheimer\'s disease, 511 European ancestry individuals with late mild cognitive impairment, 280 European ancestry individuals with early mild cognitive impairment, 94 European ancestry individuals with significant memory concern, 365 European ancestry with normal cognition','Publication':'Brain Lang','GenomewideArray':'true','ReplicateSampleSize':'NA'},'21405458':{'InitialSampleSize':null,'Publication':'Nat Commun','GenomewideArray':'true','ReplicateSampleSize':null},'21405438':{'InitialSampleSize':null,'Publication':'Nat Genet','GenomewideArray':'true','ReplicateSampleSize':null},'21405454':{'InitialSampleSize':null,'Publication':'Blood','GenomewideArray':'true','ReplicateSampleSize':null},'21405434':{'InitialSampleSize':null,'Publication':'Nat Genet','GenomewideArray':'true','ReplicateSampleSize':null}};


        var studies = Object.assign({},window.studyScoreFeatures);

        console.log('studies from server:' + studies);



        hashFromArrays = function(arr_keys,arr_values){
            if(arr_keys.length != arr_values.length){
                console.error('the number of keys(' + arr_keys + ') must be the same of the number of values(' + arr_values + ')!')
                return undefined;
            }
            var hash = {}
            arr_keys.forEach(function(i) {
                hash[i] = arr_values.shift();
            })
            return hash;
        }


        objectMap = function(object,func) {
            var keys = Object.keys(object);
            var values = Object.values(object)
            return hashFromArrays(keys, values.map(func))
        }


        var score = {
            sum : (a,b)=>{return a+b},
            normalizeByMax : (array,scale=1,keys=undefined) => {
                array = array.map(parseFloat);
                var min = Math.min(...array)
                var max = Math.max(...array)
                var normalized = array.map((v)=> {
                    if (min == max) return 1*scale;
                    return scale * (v - min)  / (max - min);
                })
                if(keys != undefined){
                    return hashFromArrays(keys,normalized);
                }
                return normalized;
            },
            takeLog : (array,keys=undefined) => {
                array = array.map(parseFloat);
                var normalized = array.map((v)=>{
                    //avoid 0
                    return Math.log(v+1);
                })
                if(keys != undefined){
                    return hashFromArrays(keys,normalized);
                }
                return normalized;
            },
            normalizeBySum : (array,scale=1,keys=undefined) => {
                var total = array.reduce(score.sum,0);
                var normalized = array.map((v)=> {
                    if (total ==0 ) return 0;
                    return scale * v/total;
                })
                if(keys != undefined){
                    return hashFromArrays(keys,normalized);
                }
                return normalized;
            },
        }

        var FRATURES = {
            InitialSampleSize : 1,
            ReplicateSampleSize : 1,
//            GenomewideArray : 1,
            SummaryStatisticsAvailable : 1,
            UserRequested : 1,

        }

        FRATURES_NOMALIZED = score.normalizeBySum(Object.values(FRATURES),Object.keys(FRATURES))

        //CLEAN STUDY DATA, replace null,na,undefined,false to 0, true to 1
        var studies_clean=Object.assign({},studies)
        Object.keys(studies_clean).map((study_id)=>{
            Object.keys(studies_clean[study_id]).map((feature)=>{
                //remove element that is not a feature
                if(Object.keys(FRATURES_NOMALIZED).indexOf(feature) == -1){
                    delete studies_clean[study_id][feature]
                }else{
                    var value = studies_clean[study_id][feature];
                    //clean
                    if(value == undefined | value==null | value === 'false' | value == "NA") {
                        value = 0;
                    }
                    if(value == 'true'){
                        value = 1;
                    }
                    studies_clean[study_id][feature] = value;
                }
            })
        })
        console.log('Clean null,na,undefined,false and true...');
        console.log(studies_clean);

        //group all feature together for nomolization across studies
        var groupByFeatures={};
        Object.keys(FRATURES).map((feature)=>{
            groupByFeatures[feature] ={};
            Object.keys(studies_clean).map((study)=>{
                groupByFeatures[feature][study] = studies_clean[study][feature]
            })
        })
        console.log('Group by features:');
        console.log(groupByFeatures);

        var groupByFeatures_nomalized = Object.assign({},groupByFeatures)
        Object.keys(groupByFeatures_nomalized).map((feature)=>{
            var featureObject = groupByFeatures_nomalized[feature];
            if(feature == 'InitialSampleSize'){
                //take log before nomalize
                featureObject = score.takeLog(Object.values(groupByFeatures_nomalized[feature]),Object.keys(groupByFeatures_nomalized[feature]));
            }
            groupByFeatures_nomalized[feature] = score.normalizeByMax(Object.values(featureObject),100,Object.keys(featureObject))
        })

        var studies_nomalized = Object.assign({},studies_clean)
        Object.keys(groupByFeatures_nomalized).map((feature)=>{
            Object.keys(groupByFeatures_nomalized[feature]).map((study)=>{
                studies_nomalized[study][feature]=groupByFeatures_nomalized[feature][study] *  FRATURES_NOMALIZED[feature];
            })
        })

        studies_score={}
        Object.keys(studies_nomalized).map((study)=>{
            studies_score[study] = Object.values(studies_nomalized[study]).reduce(score.sum,0)
        });


        //matrix
//        var parser = math.parser();
//        var a  = parser.eval('zeros(5, 3)');
//        var b  = parser.eval('[[[1, 2], [3, 4]], [[5, 6], [7, 8]]]');
//         parser.eval('d=[[[1, 2], [3, 4]], [[5, 6], [7, 8]]]');
//        b.toString()
//        parser.eval('b[1,1:end]').toString()
//
//
//
//        var matrix=math.zeros(Object.keys(studies).length,Object.keys(FRATURES).length);
//        matrix.toString();
//        Object.keys(FRATURES).map((feature)=>{
//            groupByFeatures[feature].values()
//            var dim = math.size(matrix);
//            math.subset(matrix, math.index(0), [4, 5])
//
//
//        })


        /*]]>*/
    </script>
</head>
<body>

<!--Include header-->
<div th:include="fragments/header :: navbar"></div>

<!--Include filter-->
<div th:include="fragments/study_filter :: filter"></div>
<br/>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">

            <!--Alerts-->
            <div class="container-fluid" th:if="${!#strings.isEmpty(studySnpsNotApproved)}">
                <div class="row">
                    <div class="col-md-8">
                        <div class="alert alert-danger">
                            <a href="#" class="close" data-dismiss="alert">&times;</a>
                            <strong th:text="${studySnpsNotApproved}">Note:</strong>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container-fluid" th:if="${!#strings.isEmpty(blankAssignee)}">
                <div class="row">
                    <div class="col-md-8">
                        <div class="alert alert-danger">
                            <a href="#" class="close" data-dismiss="alert">&times;</a>
                            <strong th:text="${blankAssignee}">Note:</strong>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container-fluid" th:if="${!#strings.isEmpty(blankStatus)}">
                <div class="row">
                    <div class="col-md-8">
                        <div class="alert alert-danger">
                            <a href="#" class="close" data-dismiss="alert">&times;</a>
                            <strong th:text="${blankStatus}">Note:</strong>
                        </div>
                    </div>
                </div>
            </div>
            <br/>


            <div>
                <ul class="nav nav-pills">
                    <li class="active"><a th:href="@{/studies}">All studies</a></li>
                    <br/>
                </ul>
            </div>

            <!--Table-->
            <!--Two different table views available depending on if any results are found-->
            <div th:if="${totalStudies == 0}" th:include="fragments/studies_emptytable :: empty_table"></div>
            <div th:if="${totalStudies &gt; 0}" th:include="fragments/studies_table_with_results :: results_table"></div>
        </div>

        <!--Only show bar if more that one study available and pagination is set to true-->
        <div th:if="${totalStudies &gt; 1 and #bools.isTrue(pagination) }"
             th:include="fragments/pagination_bar :: pagination_bar"></div>
    </div>
</div>

<div th:include="fragments/footer :: page_footer"></div>

</body>
</html>